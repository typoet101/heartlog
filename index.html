<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>Heart Log | ì‹¬ì¥ ê¸°ë¡</title>

    <!-- PWA -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="ì‹¬ì¥ê¸°ë¡">
    <meta name="theme-color" content="#FFF5F2">
    <link rel="apple-touch-icon" sizes="180x180" href="icon-180.png">
    <link rel="apple-touch-icon" sizes="192x192" href="icon-192.png">
    <link rel="icon" type="image/png" sizes="192x192" href="icon-192.png">
    <link rel="manifest" href="manifest.json">

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css">
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        :root {
            --bg: #FFF5F2;
            --bg-sub: #FFEEE8;
            --primary: #FF6B6B;
            --primary-light: #FF9A9A;
            --primary-dark: #E85555;
            --primary-glow: rgba(255, 107, 107, 0.25);
            --primary-soft: rgba(255, 107, 107, 0.08);
            --card: rgba(255, 255, 255, 0.75);
            --card-solid: #FFFFFF;
            --glass: rgba(255, 255, 255, 0.6);
            --glass-border: rgba(255, 255, 255, 0.8);
            --success: #6DD4B8;
            --text: #2D2424;
            --text-sub: #B09A94;
            --border: rgba(0,0,0,0.05);
            --sev1: #89CFF0;
            --sev2: #FFE066;
            --sev3: #FFB5A7;
            --sev4: #E8A0BF;
            --shadow-sm: 0 2px 8px rgba(0,0,0,0.04);
            --shadow-md: 0 4px 20px rgba(0,0,0,0.06);
            --shadow-lg: 0 8px 40px rgba(0,0,0,0.08);
            --shadow-glow: 0 8px 32px rgba(255,107,107,0.2);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Pretendard', -apple-system, sans-serif;
            background: var(--bg);
            color: var(--text);
            -webkit-font-smoothing: antialiased;
            -webkit-text-size-adjust: 100%;
            overflow-x: hidden;
        }

        /* ë°°ê²½ ê·¸ë¼ë°ì´ì…˜ ì˜¤ë¸Œ */
        body::before {
            content: '';
            position: fixed;
            top: -120px;
            right: -80px;
            width: 320px;
            height: 320px;
            border-radius: 50%;
            background: radial-gradient(circle, rgba(255,107,107,0.12) 0%, rgba(255,107,107,0.03) 60%, transparent 70%);
            pointer-events: none;
            z-index: 0;
        }
        body::after {
            content: '';
            position: fixed;
            bottom: 60px;
            left: -100px;
            width: 280px;
            height: 280px;
            border-radius: 50%;
            background: radial-gradient(circle, rgba(255,154,154,0.1) 0%, transparent 70%);
            pointer-events: none;
            z-index: 0;
        }

        @keyframes pulse {
            0%   { transform: scale(1); }
            50%  { transform: scale(1.04); }
            100% { transform: scale(1); }
        }

        @keyframes pulseGlow {
            0%   { box-shadow: 0 0 0 0 rgba(255,107,107,0.3), var(--shadow-glow); }
            50%  { box-shadow: 0 0 0 20px rgba(255,107,107,0), var(--shadow-glow); }
            100% { box-shadow: 0 0 0 0 rgba(255,107,107,0.3), var(--shadow-glow); }
        }

        @keyframes pulseRing {
            0%   { transform: scale(0.85); opacity: 0.6; }
            100% { transform: scale(1.5); opacity: 0; }
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(16px); }
            to   { opacity: 1; transform: translateY(0); }
        }

        @keyframes slideUp {
            from { transform: translateY(100%); }
            to   { transform: translateY(0); }
        }

        @keyframes chipPop {
            0%   { transform: scale(1); }
            50%  { transform: scale(1.08); }
            100% { transform: scale(1); }
        }

        @keyframes barGrow {
            from { height: 0; }
        }

        @keyframes toastIn {
            from { opacity: 0; transform: translate(-50%, -20px); }
            to   { opacity: 1; transform: translate(-50%, 0); }
        }

        @keyframes heartBeat {
            0%   { transform: scale(1); }
            15%  { transform: scale(1.15); }
            30%  { transform: scale(1); }
            45%  { transform: scale(1.1); }
            60%  { transform: scale(1); }
        }

        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50%      { transform: translateY(-6px); }
        }

        button {
            cursor: pointer;
            border: none;
            background: none;
            font-family: inherit;
            -webkit-tap-highlight-color: transparent;
        }
        button:focus-visible { outline: 3px solid var(--primary-light); outline-offset: 2px; }
        input:focus-visible, textarea:focus-visible { outline: 3px solid var(--primary-light); outline-offset: 2px; }

        /* ê¸€ë˜ìŠ¤ ì¹´ë“œ */
        .glass-card {
            background: var(--card);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            border-radius: 24px;
            box-shadow: var(--shadow-md);
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useCallback } = React;

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // ìƒìˆ˜
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        const SYMPTOMS = [
            { key: 'palpitation', label: 'ë‘ê·¼ê±°ë¦¼',  icon: 'ğŸ’“' },
            { key: 'chest_tight', label: 'ê°€ìŠ´ ë‹µë‹µ', icon: 'ğŸ˜¤' },
            { key: 'dizzy',       label: 'ì–´ì§€ëŸ¬ì›€',  icon: 'ğŸ˜µâ€ğŸ’«' },
            { key: 'breathless',  label: 'ìˆ¨ì´ ì°¸',   icon: 'ğŸ˜®â€ğŸ’¨' },
            { key: 'chest_pain',  label: 'ê°€ìŠ´ í†µì¦', icon: 'ğŸ˜–' },
            { key: 'other',       label: 'ê¸°íƒ€',      icon: 'ğŸ“' }
        ];

        const SEVERITIES = [
            { value: 1, emoji: 'ğŸ˜Š', label: 'ê´œì°®ì•„',     color: 'var(--sev1)' },
            { value: 2, emoji: 'ğŸ˜', label: 'ì¢€ ë¶ˆí¸í•´',   color: 'var(--sev2)' },
            { value: 3, emoji: 'ğŸ˜£', label: 'í˜ë“¤ì–´',     color: 'var(--sev3)' },
            { value: 4, emoji: 'ğŸ˜°', label: 'ë§ì´ í˜ë“¤ì–´', color: 'var(--sev4)' }
        ];

        const ACTIVITIES = [
            { key: 'rest',     label: 'ê°€ë§Œíˆ ìˆìŒ', icon: 'ğŸ§˜' },
            { key: 'walking',  label: 'ê±·ëŠ” ì¤‘',    icon: 'ğŸš¶' },
            { key: 'running',  label: 'ë›°ëŠ” ì¤‘',    icon: 'ğŸƒ' },
            { key: 'exercise', label: 'ìš´ë™ ì¤‘',    icon: 'âš½' },
            { key: 'sleeping', label: 'ì ìëŠ” ì¤‘',  icon: 'ğŸ˜´' },
            { key: 'class',    label: 'ìˆ˜ì—… ì¤‘',    icon: 'ğŸ“š' }
        ];

        const DAYS_KO = ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '];
        const STORAGE_KEY = 'heartlog_records';

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // ë°ì´í„° ë ˆì´ì–´
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        function loadRecords() {
            try {
                const raw = localStorage.getItem(STORAGE_KEY);
                if (!raw) return [];
                return JSON.parse(raw).records || [];
            } catch { return []; }
        }

        function saveRecords(records) {
            localStorage.setItem(STORAGE_KEY, JSON.stringify({ version: 2, records }));
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // Google Sheets ë™ê¸°í™”
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        const SHEET_URL_KEY = 'heartlog_sheet_url';
        function getSheetUrl() { return localStorage.getItem(SHEET_URL_KEY) || ''; }
        function setSheetUrl(url) { localStorage.setItem(SHEET_URL_KEY, url); }

        async function syncToSheet(record) {
            const url = getSheetUrl();
            if (!url) return { ok: false, reason: 'no_url' };
            try {
                const sevInfo = getSeverityInfo(record.severity);
                await fetch(url, {
                    method: 'POST', mode: 'no-cors',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'add', timestamp: record.timestamp,
                        date: new Date(record.timestamp).toLocaleDateString('ko-KR'),
                        time: formatTime(record.timestamp),
                        symptoms: record.symptoms.map(getSymptomLabel).join(', '),
                        severity: sevInfo ? `${sevInfo.emoji} ${sevInfo.label}` : '',
                        activity: getActivityLabel(record.activity),
                        duration: record.durationSeconds ? formatDuration(record.durationSeconds) : '',
                        memo: record.memo || ''
                    })
                });
                return { ok: true };
            } catch (e) { return { ok: false, reason: 'network' }; }
        }

        async function syncDeleteToSheet(recordId) {
            const url = getSheetUrl();
            if (!url) return;
            try {
                await fetch(url, {
                    method: 'POST', mode: 'no-cors',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action: 'delete', id: recordId })
                });
            } catch (e) {}
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // ìœ í‹¸
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        function formatDate(d) {
            const date = new Date(d);
            return `${date.getMonth() + 1}ì›” ${date.getDate()}ì¼ ${DAYS_KO[date.getDay()]}ìš”ì¼`;
        }
        function formatTime(d) {
            const date = new Date(d);
            return `${String(date.getHours()).padStart(2,'0')}:${String(date.getMinutes()).padStart(2,'0')}`;
        }
        function formatDateShort(d) {
            const date = new Date(d);
            return `${date.getMonth() + 1}ì›” ${date.getDate()}ì¼ (${DAYS_KO[date.getDay()]})`;
        }
        function formatDuration(sec) {
            if (!sec) return null;
            const m = Math.floor(sec / 60), s = sec % 60;
            return m > 0 ? `${m}ë¶„ ${s}ì´ˆ` : `${s}ì´ˆ`;
        }
        function isSameDay(d1, d2) {
            const a = new Date(d1), b = new Date(d2);
            return a.getFullYear() === b.getFullYear() && a.getMonth() === b.getMonth() && a.getDate() === b.getDate();
        }
        function getSymptomLabel(key) { return SYMPTOMS.find(s => s.key === key)?.label || key; }
        function getActivityLabel(key) { return ACTIVITIES.find(a => a.key === key)?.label || key; }
        function getSeverityInfo(val) { return SEVERITIES.find(s => s.value === val); }
        function vibrate() { if (navigator.vibrate) navigator.vibrate(50); }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // í† ìŠ¤íŠ¸
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        function Toast({ message, show }) {
            if (!show) return null;
            return (
                <div style={{
                    position: 'fixed', top: 60, left: '50%',
                    transform: 'translateX(-50%)',
                    background: 'rgba(109,212,184,0.95)',
                    backdropFilter: 'blur(12px)',
                    color: '#fff', padding: '14px 32px',
                    borderRadius: 20, fontSize: 15, fontWeight: 700, zIndex: 200,
                    animation: 'toastIn 0.3s ease',
                    boxShadow: '0 8px 32px rgba(109,212,184,0.3)'
                }}>
                    {message}
                </div>
            );
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // íƒ­ë°” (ì…ì²´ê° ìˆëŠ” í•˜ë‹¨ë°”)
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        function TabBar({ activeTab, onTabChange }) {
            const tabs = [
                { key: 'home', label: 'í™ˆ', iconActive: (
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
                        <path d="M3 10.5L12 3L21 10.5V20C21 20.5 20.5 21 20 21H15V15H9V21H4C3.5 21 3 20.5 3 20V10.5Z" fill="var(--primary)" stroke="var(--primary)" strokeWidth="1.5" strokeLinejoin="round"/>
                    </svg>
                ), iconInactive: (
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
                        <path d="M3 10.5L12 3L21 10.5V20C21 20.5 20.5 21 20 21H15V15H9V21H4C3.5 21 3 20.5 3 20V10.5Z" stroke="var(--text-sub)" strokeWidth="1.5" strokeLinejoin="round"/>
                    </svg>
                )},
                { key: 'history', label: 'ê¸°ë¡', iconActive: (
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
                        <circle cx="12" cy="12" r="9" stroke="var(--primary)" strokeWidth="1.5"/>
                        <path d="M12 7V12L15 15" stroke="var(--primary)" strokeWidth="1.5" strokeLinecap="round"/>
                    </svg>
                ), iconInactive: (
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
                        <circle cx="12" cy="12" r="9" stroke="var(--text-sub)" strokeWidth="1.5"/>
                        <path d="M12 7V12L15 15" stroke="var(--text-sub)" strokeWidth="1.5" strokeLinecap="round"/>
                    </svg>
                )},
                { key: 'stats', label: 'í†µê³„', iconActive: (
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
                        <rect x="4" y="13" width="4" height="7" rx="1" fill="var(--primary)"/>
                        <rect x="10" y="8" width="4" height="12" rx="1" fill="var(--primary)"/>
                        <rect x="16" y="4" width="4" height="16" rx="1" fill="var(--primary)"/>
                    </svg>
                ), iconInactive: (
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
                        <rect x="4" y="13" width="4" height="7" rx="1" stroke="var(--text-sub)" strokeWidth="1.5"/>
                        <rect x="10" y="8" width="4" height="12" rx="1" stroke="var(--text-sub)" strokeWidth="1.5"/>
                        <rect x="16" y="4" width="4" height="16" rx="1" stroke="var(--text-sub)" strokeWidth="1.5"/>
                    </svg>
                )},
                { key: 'settings', label: 'ì„¤ì •', iconActive: (
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
                        <circle cx="12" cy="12" r="3" fill="var(--primary)"/>
                        <path d="M12 1v3M12 20v3M4.22 4.22l2.12 2.12M17.66 17.66l2.12 2.12M1 12h3M20 12h3M4.22 19.78l2.12-2.12M17.66 6.34l2.12-2.12" stroke="var(--primary)" strokeWidth="1.5" strokeLinecap="round"/>
                    </svg>
                ), iconInactive: (
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
                        <circle cx="12" cy="12" r="3" stroke="var(--text-sub)" strokeWidth="1.5"/>
                        <path d="M12 1v3M12 20v3M4.22 4.22l2.12 2.12M17.66 17.66l2.12 2.12M1 12h3M20 12h3M4.22 19.78l2.12-2.12M17.66 6.34l2.12-2.12" stroke="var(--text-sub)" strokeWidth="1.5" strokeLinecap="round"/>
                    </svg>
                )}
            ];
            return (
                <nav style={{
                    position: 'fixed', bottom: 0, left: 0, right: 0,
                    background: 'rgba(255,255,255,0.85)',
                    backdropFilter: 'blur(20px)', WebkitBackdropFilter: 'blur(20px)',
                    borderTop: '1px solid rgba(0,0,0,0.04)',
                    display: 'flex', height: 72,
                    paddingBottom: 'env(safe-area-inset-bottom)',
                    zIndex: 50
                }}>
                    {tabs.map(t => (
                        <button key={t.key} onClick={() => onTabChange(t.key)} style={{
                            flex: 1, display: 'flex', flexDirection: 'column',
                            alignItems: 'center', justifyContent: 'center', gap: 4,
                            position: 'relative'
                        }}>
                            {activeTab === t.key && (
                                <div style={{
                                    position: 'absolute', top: -1, left: '50%', transform: 'translateX(-50%)',
                                    width: 24, height: 3, borderRadius: 2,
                                    background: 'var(--primary)'
                                }} />
                            )}
                            <div style={{
                                width: 44, height: 44, borderRadius: 16,
                                display: 'flex', alignItems: 'center', justifyContent: 'center',
                                background: activeTab === t.key ? 'var(--primary-soft)' : 'transparent',
                                transition: 'all 0.25s ease'
                            }}>
                                {activeTab === t.key ? t.iconActive : t.iconInactive}
                            </div>
                            <span style={{
                                fontSize: 10, fontWeight: activeTab === t.key ? 800 : 500,
                                color: activeTab === t.key ? 'var(--primary)' : 'var(--text-sub)',
                                transition: 'all 0.2s'
                            }}>{t.label}</span>
                        </button>
                    ))}
                </nav>
            );
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // ë©”ì¸ í™”ë©´ (ì…ì²´ê° ìˆëŠ” 3D ë²„íŠ¼)
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        function MainScreen({ todayCount, onAlarm, timerRunning, timerElapsed, onTimerStart, onTimerStop }) {
            const now = new Date();
            const timerDisplay = useCallback(() => {
                const totalSec = Math.floor(timerElapsed / 1000);
                const m = String(Math.floor(totalSec / 60)).padStart(2, '0');
                const s = String(totalSec % 60).padStart(2, '0');
                return `${m}:${s}`;
            }, [timerElapsed]);

            return (
                <div style={{
                    minHeight: '100vh', minHeight: '100dvh',
                    display: 'flex', flexDirection: 'column', alignItems: 'center',
                    paddingTop: 'max(60px, env(safe-area-inset-top, 60px))',
                    paddingBottom: 120,
                    animation: 'fadeIn 0.5s ease',
                    position: 'relative', zIndex: 1
                }}>
                    {/* ë‚ ì§œ & ì¹´ìš´íŠ¸ */}
                    <div style={{ textAlign: 'left', width: '100%', padding: '0 28px', marginBottom: 48 }}>
                        <p style={{ fontSize: 15, color: 'var(--text-sub)', fontWeight: 500, letterSpacing: '-0.3px' }}>
                            {formatDate(now)}
                        </p>
                        <h1 style={{ fontSize: 28, fontWeight: 800, color: 'var(--text)', marginTop: 6, lineHeight: 1.3 }}>
                            ì˜¤ëŠ˜ í•˜ë£¨,
                        </h1>
                        <h1 style={{ fontSize: 28, fontWeight: 800, color: 'var(--primary)', lineHeight: 1.3 }}>
                            ì‹¬ì¥ ê¸°ë¡ {todayCount}ê±´
                        </h1>
                    </div>

                    {/* 3D ì•ŒëŒ ë²„íŠ¼ ì˜ì—­ */}
                    <div style={{
                        position: 'relative',
                        width: 240, height: 240,
                        display: 'flex', alignItems: 'center', justifyContent: 'center',
                        marginBottom: 24
                    }}>
                        {/* ì™¸ë¶€ ê¸€ë¡œìš° ë§ 1 */}
                        <div style={{
                            position: 'absolute', inset: 0,
                            borderRadius: '50%',
                            background: 'radial-gradient(circle, rgba(255,107,107,0.08) 40%, transparent 70%)',
                            animation: 'pulse 3s ease-in-out infinite'
                        }} />
                        {/* ì™¸ë¶€ ê¸€ë¡œìš° ë§ 2 */}
                        <div style={{
                            position: 'absolute',
                            width: 200, height: 200,
                            left: 20, top: 20,
                            borderRadius: '50%',
                            background: 'radial-gradient(circle, rgba(255,107,107,0.12) 30%, transparent 70%)',
                            animation: 'pulse 3s ease-in-out 0.5s infinite'
                        }} />
                        {/* ë©”ì¸ ë²„íŠ¼ */}
                        <button
                            onClick={() => { vibrate(); onAlarm(); }}
                            style={{
                                width: 160, height: 160, borderRadius: '50%',
                                background: 'radial-gradient(circle at 35% 30%, #FF9A9A 0%, #FF6B6B 50%, #E85555 100%)',
                                color: '#fff', display: 'flex', flexDirection: 'column',
                                alignItems: 'center', justifyContent: 'center', gap: 8,
                                border: 'none',
                                boxShadow: '0 8px 32px rgba(255,107,107,0.35), inset 0 -4px 12px rgba(0,0,0,0.1), inset 0 4px 8px rgba(255,255,255,0.25)',
                                animation: 'pulseGlow 2.5s ease-in-out infinite',
                                transition: 'transform 0.15s ease',
                                position: 'relative', zIndex: 2
                            }}
                            onTouchStart={e => e.currentTarget.style.transform = 'scale(0.92)'}
                            onTouchEnd={e => e.currentTarget.style.transform = 'scale(1)'}
                            onMouseDown={e => e.currentTarget.style.transform = 'scale(0.92)'}
                            onMouseUp={e => e.currentTarget.style.transform = 'scale(1)'}
                        >
                            <span style={{ fontSize: 42, filter: 'drop-shadow(0 2px 4px rgba(0,0,0,0.15))', animation: 'heartBeat 1.5s ease-in-out infinite' }}>ğŸ’“</span>
                            <span style={{ fontSize: 18, fontWeight: 800, textShadow: '0 1px 3px rgba(0,0,0,0.15)' }}>ê¸°ë¡í•˜ê¸°</span>
                        </button>
                    </div>

                    {/* ì•ˆë‚´ ë¬¸êµ¬ */}
                    <p style={{
                        fontSize: 15, color: 'var(--text-sub)', fontWeight: 500,
                        textAlign: 'center', lineHeight: 1.6, marginBottom: 36
                    }}>
                        ì‹¬ì¥ì´ ë‘ê·¼ê±°ë¦¬ê±°ë‚˜ ë¶ˆí¸í•˜ë©´<br/>
                        ê°€ìš´ë° ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”
                    </p>

                    {/* íƒ€ì´ë¨¸ ì¹´ë“œ */}
                    <div className="glass-card" style={{
                        margin: '0 24px', padding: '18px 24px',
                        display: 'flex', alignItems: 'center', justifyContent: 'space-between',
                        width: 'calc(100% - 48px)', maxWidth: 380
                    }}>
                        <div>
                            <p style={{ fontSize: 13, color: 'var(--text-sub)', fontWeight: 600, marginBottom: 4 }}>
                                â± ì¦ìƒ ì§€ì† ì‹œê°„ ì¸¡ì •
                            </p>
                            <span style={{
                                fontSize: 36, fontWeight: 800, fontVariantNumeric: 'tabular-nums',
                                color: timerRunning ? 'var(--text)' : 'var(--text-sub)',
                                letterSpacing: '2px'
                            }}>
                                {timerDisplay()}
                            </span>
                        </div>
                        <button
                            onClick={timerRunning ? onTimerStop : onTimerStart}
                            style={{
                                width: 52, height: 52, borderRadius: '50%',
                                background: timerRunning
                                    ? 'linear-gradient(135deg, var(--primary), var(--primary-dark))'
                                    : 'var(--bg-sub)',
                                display: 'flex', alignItems: 'center', justifyContent: 'center',
                                boxShadow: timerRunning ? '0 4px 16px rgba(255,107,107,0.3)' : 'var(--shadow-sm)',
                                transition: 'all 0.3s ease'
                            }}
                        >
                            {timerRunning ? (
                                <svg width="20" height="20" viewBox="0 0 20 20" fill="white">
                                    <rect x="4" y="3" width="4" height="14" rx="1"/>
                                    <rect x="12" y="3" width="4" height="14" rx="1"/>
                                </svg>
                            ) : (
                                <svg width="20" height="20" viewBox="0 0 20 20" fill="var(--primary)">
                                    <path d="M5 3L17 10L5 17V3Z"/>
                                </svg>
                            )}
                        </button>
                    </div>
                </div>
            );
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // ì¦ìƒ ê¸°ë¡ íŒ¨ë„
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        function SymptomRecordPanel({ isOpen, onClose, onSave, timerElapsed }) {
            const [symptoms, setSymptoms] = useState([]);
            const [severity, setSeverity] = useState(null);
            const [activity, setActivity] = useState(null);
            const [memo, setMemo] = useState('');
            const [timestamp] = useState(() => new Date().toISOString());
            const [saving, setSaving] = useState(false);
            const [error, setError] = useState('');

            useEffect(() => {
                if (isOpen) { setSymptoms([]); setSeverity(null); setActivity(null); setMemo(''); setSaving(false); setError(''); }
            }, [isOpen]);

            const toggleSymptom = (key) => { setError(''); setSymptoms(prev => prev.includes(key) ? prev.filter(k => k !== key) : [...prev, key]); };

            const handleSave = () => {
                if (symptoms.length === 0) { setError('ì¦ìƒì„ ì„ íƒí•´ì£¼ì„¸ìš”'); return; }
                setSaving(true); vibrate();
                setTimeout(() => {
                    onSave({
                        id: crypto.randomUUID ? crypto.randomUUID() : Date.now().toString(36) + Math.random().toString(36).slice(2),
                        timestamp, symptoms, severity: severity || 1, activity: activity || 'rest',
                        durationSeconds: timerElapsed ? Math.floor(timerElapsed / 1000) : null, memo
                    });
                }, 500);
            };

            if (!isOpen) return null;

            const chipStyle = (selected) => ({
                display: 'inline-flex', alignItems: 'center', gap: 6,
                padding: '12px 18px', borderRadius: 20,
                border: `2px solid ${selected ? 'var(--primary)' : 'rgba(0,0,0,0.06)'}`,
                background: selected ? 'var(--primary)' : 'rgba(255,255,255,0.9)',
                color: selected ? '#fff' : 'var(--text)',
                fontSize: 15, fontWeight: 600,
                boxShadow: selected ? '0 4px 16px rgba(255,107,107,0.25)' : 'var(--shadow-sm)',
                transition: 'all 0.2s ease',
                animation: selected ? 'chipPop 0.25s ease' : 'none'
            });

            return (
                <div style={{
                    position: 'fixed', inset: 0, zIndex: 100,
                    background: 'var(--bg)',
                    animation: 'slideUp 0.35s cubic-bezier(0.33, 1, 0.68, 1)',
                    overflowY: 'auto', WebkitOverflowScrolling: 'touch'
                }}>
                    <div style={{ maxWidth: 500, margin: '0 auto', padding: '20px 24px 40px' }}>
                        {/* í—¤ë” */}
                        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: 32 }}>
                            <button onClick={onClose} style={{
                                width: 44, height: 44, borderRadius: 16,
                                background: 'rgba(0,0,0,0.04)', display: 'flex',
                                alignItems: 'center', justifyContent: 'center', fontSize: 18
                            }}>âœ•</button>
                            <span style={{ fontSize: 14, color: 'var(--text-sub)', fontWeight: 600 }}>
                                ê¸°ë¡ ì¤‘ Â· {formatTime(timestamp)}
                            </span>
                        </div>

                        {/* 1. ì¦ìƒ */}
                        <section style={{ marginBottom: 32 }}>
                            <h3 style={{ fontSize: 17, fontWeight: 800, marginBottom: 14 }}>
                                ì–´ë–¤ ì¦ìƒì´ì•¼? <span style={{ fontSize: 13, fontWeight: 500, color: 'var(--text-sub)' }}>(ì—¬ëŸ¬ ê°œ ê°€ëŠ¥)</span>
                            </h3>
                            {error && <p style={{ color: '#FF6B6B', fontSize: 14, fontWeight: 600, marginBottom: 10 }}>{error}</p>}
                            <div style={{ display: 'flex', flexWrap: 'wrap', gap: 10 }}>
                                {SYMPTOMS.map(s => (
                                    <button key={s.key} onClick={() => toggleSymptom(s.key)} style={chipStyle(symptoms.includes(s.key))}>
                                        <span>{s.icon}</span> {s.label}
                                    </button>
                                ))}
                            </div>
                        </section>

                        {/* 2. ê°•ë„ */}
                        <section style={{ marginBottom: 32 }}>
                            <h3 style={{ fontSize: 17, fontWeight: 800, marginBottom: 14 }}>ì–¼ë§ˆë‚˜ í˜ë“¤ì–´?</h3>
                            <div style={{ display: 'flex', gap: 10 }}>
                                {SEVERITIES.map(s => (
                                    <button key={s.value} onClick={() => setSeverity(s.value)} style={{
                                        flex: 1, padding: '16px 4px', borderRadius: 20,
                                        border: `2px solid ${severity === s.value ? s.color : 'rgba(0,0,0,0.05)'}`,
                                        background: severity === s.value ? `${s.color}18` : 'rgba(255,255,255,0.9)',
                                        display: 'flex', flexDirection: 'column', alignItems: 'center', gap: 6,
                                        transform: severity === s.value ? 'scale(1.05)' : 'scale(1)',
                                        transition: 'all 0.2s ease',
                                        boxShadow: severity === s.value ? `0 4px 16px ${s.color}30` : 'var(--shadow-sm)'
                                    }}>
                                        <span style={{ fontSize: 30 }}>{s.emoji}</span>
                                        <span style={{ fontSize: 11, fontWeight: 700, color: 'var(--text-sub)' }}>{s.label}</span>
                                    </button>
                                ))}
                            </div>
                        </section>

                        {/* 3. í™œë™ */}
                        <section style={{ marginBottom: 32 }}>
                            <h3 style={{ fontSize: 17, fontWeight: 800, marginBottom: 14 }}>ë­í•˜ê³  ìˆì—ˆì–´?</h3>
                            <div style={{ display: 'flex', flexWrap: 'wrap', gap: 10 }}>
                                {ACTIVITIES.map(a => (
                                    <button key={a.key} onClick={() => setActivity(a.key)} style={chipStyle(activity === a.key)}>
                                        <span>{a.icon}</span> {a.label}
                                    </button>
                                ))}
                            </div>
                        </section>

                        {/* 4. ë©”ëª¨ */}
                        <section style={{ marginBottom: 36 }}>
                            <h3 style={{ fontSize: 17, fontWeight: 800, marginBottom: 14 }}>
                                ë©”ëª¨ <span style={{ fontSize: 13, fontWeight: 500, color: 'var(--text-sub)' }}>(ì„ íƒ)</span>
                            </h3>
                            <textarea
                                value={memo} onChange={e => setMemo(e.target.value)}
                                placeholder="ë” í•˜ê³  ì‹¶ì€ ë§ì´ ìˆìœ¼ë©´ ì ì–´ì¤˜"
                                style={{
                                    width: '100%', height: 88, borderRadius: 20,
                                    border: '2px solid rgba(0,0,0,0.05)', padding: 16,
                                    fontSize: 15, fontFamily: 'inherit', resize: 'none',
                                    background: 'rgba(255,255,255,0.9)', color: 'var(--text)',
                                    boxShadow: 'var(--shadow-sm)'
                                }}
                            />
                        </section>

                        {/* ì €ì¥ ë²„íŠ¼ */}
                        <button onClick={handleSave} disabled={saving} style={{
                            width: '100%', height: 60, borderRadius: 22,
                            background: saving ? 'var(--success)' : 'linear-gradient(135deg, #FF9A9A, #FF6B6B)',
                            color: '#fff', fontSize: 18, fontWeight: 800,
                            transition: 'all 0.3s ease',
                            boxShadow: saving ? '0 4px 20px rgba(109,212,184,0.3)' : '0 6px 24px rgba(255,107,107,0.3)'
                        }}>
                            {saving ? 'âœ“ ì €ì¥í–ˆì–´ìš”!' : 'ì €ì¥í•˜ê¸°'}
                        </button>
                    </div>
                </div>
            );
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // ê¸°ë¡ ìƒì„¸ ëª¨ë‹¬
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        function RecordDetailModal({ record, onClose, onDelete }) {
            if (!record) return null;
            const sevInfo = getSeverityInfo(record.severity);
            return (
                <div style={{
                    position: 'fixed', inset: 0, zIndex: 110,
                    background: 'rgba(0,0,0,0.25)', backdropFilter: 'blur(4px)',
                    display: 'flex', alignItems: 'flex-end', justifyContent: 'center'
                }} onClick={onClose}>
                    <div style={{
                        background: '#fff', borderRadius: '28px 28px 0 0',
                        width: '100%', maxWidth: 500, padding: '28px 24px 40px',
                        animation: 'slideUp 0.3s ease',
                        boxShadow: '0 -4px 40px rgba(0,0,0,0.08)'
                    }} onClick={e => e.stopPropagation()}>
                        <div style={{ width: 40, height: 4, borderRadius: 2, background: 'rgba(0,0,0,0.1)', margin: '0 auto 20px' }} />
                        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: 20 }}>
                            <h3 style={{ fontSize: 20, fontWeight: 800 }}>ê¸°ë¡ ìƒì„¸</h3>
                            <button onClick={onClose} style={{
                                width: 40, height: 40, borderRadius: 14,
                                background: 'rgba(0,0,0,0.04)', fontSize: 16,
                                display: 'flex', alignItems: 'center', justifyContent: 'center'
                            }}>âœ•</button>
                        </div>
                        <p style={{ fontSize: 14, color: 'var(--text-sub)', marginBottom: 18 }}>
                            {formatDateShort(record.timestamp)} {formatTime(record.timestamp)}
                        </p>
                        <div style={{ marginBottom: 14 }}>
                            <p style={{ fontSize: 13, color: 'var(--text-sub)', fontWeight: 600, marginBottom: 8 }}>ì¦ìƒ</p>
                            <div style={{ display: 'flex', flexWrap: 'wrap', gap: 8 }}>
                                {record.symptoms.map(s => (
                                    <span key={s} style={{ padding: '8px 14px', borderRadius: 14, background: 'var(--bg-sub)', fontSize: 14, fontWeight: 600 }}>{getSymptomLabel(s)}</span>
                                ))}
                            </div>
                        </div>
                        {sevInfo && <div style={{ marginBottom: 14 }}><p style={{ fontSize: 13, color: 'var(--text-sub)', fontWeight: 600, marginBottom: 6 }}>í˜ë“  ì •ë„</p><span style={{ fontSize: 16 }}>{sevInfo.emoji} {sevInfo.label}</span></div>}
                        <div style={{ marginBottom: 14 }}><p style={{ fontSize: 13, color: 'var(--text-sub)', fontWeight: 600, marginBottom: 6 }}>í™œë™</p><span style={{ fontSize: 16 }}>{getActivityLabel(record.activity)}</span></div>
                        {record.durationSeconds && <div style={{ marginBottom: 14 }}><p style={{ fontSize: 13, color: 'var(--text-sub)', fontWeight: 600, marginBottom: 6 }}>ì§€ì† ì‹œê°„</p><span style={{ fontSize: 16 }}>{formatDuration(record.durationSeconds)}</span></div>}
                        {record.memo && <div style={{ marginBottom: 14 }}><p style={{ fontSize: 13, color: 'var(--text-sub)', fontWeight: 600, marginBottom: 6 }}>ë©”ëª¨</p><p style={{ fontSize: 15, lineHeight: 1.5, background: 'var(--bg-sub)', padding: 14, borderRadius: 16 }}>{record.memo}</p></div>}
                        <button onClick={() => onDelete(record.id)} style={{
                            width: '100%', marginTop: 12, padding: '15px', borderRadius: 18,
                            background: 'rgba(255,107,107,0.08)', color: 'var(--primary)',
                            fontSize: 15, fontWeight: 700
                        }}>ì‚­ì œí•˜ê¸°</button>
                    </div>
                </div>
            );
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // ê¸°ë¡ ëª©ë¡
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        function RecordScreen({ records, onDeleteRecord }) {
            const [currentYear, setCurrentYear] = useState(new Date().getFullYear());
            const [currentMonth, setCurrentMonth] = useState(new Date().getMonth());
            const [selectedRecord, setSelectedRecord] = useState(null);
            const [confirmDelete, setConfirmDelete] = useState(null);

            const filtered = records.filter(r => {
                const d = new Date(r.timestamp);
                return d.getFullYear() === currentYear && d.getMonth() === currentMonth;
            }).sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

            const groups = {};
            filtered.forEach(r => { const k = new Date(r.timestamp).toDateString(); if (!groups[k]) groups[k] = []; groups[k].push(r); });

            const prevMonth = () => { if (currentMonth === 0) { setCurrentMonth(11); setCurrentYear(y => y - 1); } else setCurrentMonth(m => m - 1); };
            const nextMonth = () => { if (currentMonth === 11) { setCurrentMonth(0); setCurrentYear(y => y + 1); } else setCurrentMonth(m => m + 1); };
            const handleDelete = (id) => setConfirmDelete(id);
            const confirmDeleteAction = () => { onDeleteRecord(confirmDelete); setConfirmDelete(null); setSelectedRecord(null); };

            return (
                <div style={{ minHeight: '100dvh', maxWidth: 500, margin: '0 auto', padding: '24px 20px 100px', animation: 'fadeIn 0.4s ease', position: 'relative', zIndex: 1 }}>
                    <h2 style={{ fontSize: 26, fontWeight: 800, marginBottom: 20 }}>ê¸°ë¡ ëª©ë¡</h2>
                    <div style={{ display: 'flex', justifyContent: 'center', alignItems: 'center', gap: 28, marginBottom: 24 }}>
                        <button onClick={prevMonth} style={{ width: 44, height: 44, borderRadius: 16, background: 'rgba(0,0,0,0.04)', fontSize: 16, display: 'flex', alignItems: 'center', justifyContent: 'center' }}>â—€</button>
                        <span style={{ fontSize: 18, fontWeight: 800, minWidth: 100, textAlign: 'center' }}>
                            {currentYear === new Date().getFullYear() ? '' : `${currentYear}ë…„ `}{currentMonth + 1}ì›”
                        </span>
                        <button onClick={nextMonth} style={{ width: 44, height: 44, borderRadius: 16, background: 'rgba(0,0,0,0.04)', fontSize: 16, display: 'flex', alignItems: 'center', justifyContent: 'center' }}>â–¶</button>
                    </div>

                    {filtered.length === 0 && (
                        <div style={{ textAlign: 'center', paddingTop: 80, color: 'var(--text-sub)' }}>
                            <p style={{ fontSize: 48, marginBottom: 12 }}>ğŸ“</p>
                            <p style={{ fontSize: 16, fontWeight: 600 }}>ì´ë²ˆ ë‹¬ ê¸°ë¡ì´ ì—†ì–´ìš”</p>
                        </div>
                    )}

                    {Object.entries(groups).map(([dateKey, recs]) => (
                        <div key={dateKey} style={{ marginBottom: 20 }}>
                            <div style={{ display: 'flex', justifyContent: 'space-between', padding: '8px 4px', marginBottom: 8 }}>
                                <span style={{ fontSize: 14, fontWeight: 700, color: 'var(--text-sub)' }}>{formatDateShort(recs[0].timestamp)}</span>
                                <span style={{ fontSize: 13, fontWeight: 700, color: 'var(--primary)' }}>{recs.length}ê±´</span>
                            </div>
                            {recs.map(r => {
                                const sevInfo = getSeverityInfo(r.severity);
                                return (
                                    <button key={r.id} onClick={() => setSelectedRecord(r)} className="glass-card" style={{
                                        width: '100%', textAlign: 'left', padding: '16px 18px', marginBottom: 10,
                                        display: 'block', transition: 'transform 0.15s'
                                    }}>
                                        <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: 6 }}>
                                            <span style={{ fontSize: 13, color: 'var(--text-sub)', fontWeight: 700 }}>{formatTime(r.timestamp)}</span>
                                            {r.durationSeconds && <span style={{ fontSize: 12, color: 'var(--text-sub)' }}>â± {formatDuration(r.durationSeconds)}</span>}
                                        </div>
                                        <p style={{ fontSize: 16, fontWeight: 700, marginBottom: 8 }}>{r.symptoms.map(getSymptomLabel).join(', ')}</p>
                                        <div style={{ display: 'flex', gap: 8, flexWrap: 'wrap' }}>
                                            {sevInfo && <span style={{ padding: '4px 12px', borderRadius: 12, background: `${sevInfo.color}20`, fontSize: 13, fontWeight: 600 }}>{sevInfo.emoji} {sevInfo.label}</span>}
                                            <span style={{ padding: '4px 12px', borderRadius: 12, background: 'var(--bg-sub)', fontSize: 13, fontWeight: 600 }}>{getActivityLabel(r.activity)}</span>
                                        </div>
                                        {r.memo && <p style={{ marginTop: 8, fontSize: 13, color: 'var(--text-sub)', overflow: 'hidden', textOverflow: 'ellipsis', whiteSpace: 'nowrap' }}>ğŸ’¬ {r.memo}</p>}
                                    </button>
                                );
                            })}
                        </div>
                    ))}

                    <RecordDetailModal record={selectedRecord} onClose={() => setSelectedRecord(null)} onDelete={handleDelete} />
                    {confirmDelete && (
                        <div style={{ position: 'fixed', inset: 0, zIndex: 120, background: 'rgba(0,0,0,0.3)', backdropFilter: 'blur(4px)', display: 'flex', alignItems: 'center', justifyContent: 'center' }}>
                            <div style={{ background: '#fff', borderRadius: 28, padding: '28px 24px', width: '85%', maxWidth: 320, textAlign: 'center', boxShadow: 'var(--shadow-lg)' }}>
                                <p style={{ fontSize: 17, fontWeight: 700, marginBottom: 20 }}>ì´ ê¸°ë¡ì„ ì‚­ì œí• ê¹Œìš”?</p>
                                <div style={{ display: 'flex', gap: 10 }}>
                                    <button onClick={() => setConfirmDelete(null)} style={{ flex: 1, padding: '15px', borderRadius: 16, background: 'rgba(0,0,0,0.04)', fontSize: 15, fontWeight: 700, color: 'var(--text-sub)' }}>ì·¨ì†Œ</button>
                                    <button onClick={confirmDeleteAction} style={{ flex: 1, padding: '15px', borderRadius: 16, background: 'rgba(255,107,107,0.1)', fontSize: 15, fontWeight: 700, color: 'var(--primary)' }}>ì‚­ì œ</button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // í†µê³„
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        function StatsScreen({ records }) {
            const [period, setPeriod] = useState('week');
            const [copied, setCopied] = useState(false);
            const now = new Date();

            const getStartDate = () => {
                const d = new Date(now);
                if (period === 'week') { const day = d.getDay(); d.setDate(d.getDate() - (day === 0 ? 6 : day - 1)); }
                else d.setDate(1);
                d.setHours(0, 0, 0, 0); return d;
            };

            const startDate = getStartDate();
            const filtered = records.filter(r => new Date(r.timestamp) >= startDate);

            const dailyCounts = (() => {
                if (period === 'week') {
                    const counts = [0,0,0,0,0,0,0];
                    filtered.forEach(r => { let di = new Date(r.timestamp).getDay() - 1; if (di < 0) di = 6; counts[di]++; });
                    return counts;
                } else {
                    const dim = new Date(now.getFullYear(), now.getMonth() + 1, 0).getDate();
                    const weeks = Math.ceil(dim / 7); const counts = new Array(weeks).fill(0);
                    filtered.forEach(r => { const wi = Math.floor((new Date(r.timestamp).getDate() - 1) / 7); if (wi < counts.length) counts[wi]++; });
                    return counts;
                }
            })();
            const maxCount = Math.max(...dailyCounts, 1);

            const symptomCounts = {};
            filtered.forEach(r => r.symptoms.forEach(s => { symptomCounts[s] = (symptomCounts[s] || 0) + 1; }));
            const symptomRanking = Object.entries(symptomCounts).sort((a, b) => b[1] - a[1]).slice(0, 5);
            const activityCounts = {};
            filtered.forEach(r => { activityCounts[r.activity] = (activityCounts[r.activity] || 0) + 1; });
            const activityRanking = Object.entries(activityCounts).sort((a, b) => b[1] - a[1]).slice(0, 5);
            const maxSymptomCount = symptomRanking.length > 0 ? symptomRanking[0][1] : 1;

            const handleExport = () => {
                const lines = ['=== ì‹¬ì¥ ê¸°ë¡ (Heart Log) ==='];
                const sortedAll = [...records].sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                if (sortedAll.length === 0) lines.push('ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.');
                else {
                    lines.push(`ê¸°ê°„: ${new Date(sortedAll[sortedAll.length-1].timestamp).toLocaleDateString('ko-KR')} ~ ${new Date(sortedAll[0].timestamp).toLocaleDateString('ko-KR')}`);
                    lines.push(`ì´ ê¸°ë¡: ${sortedAll.length}ê±´\n`);
                    sortedAll.forEach(r => {
                        const si = getSeverityInfo(r.severity);
                        lines.push('---');
                        lines.push(`${formatDateShort(r.timestamp)} ${formatTime(r.timestamp)}`);
                        lines.push(`ì¦ìƒ: ${r.symptoms.map(getSymptomLabel).join(', ')}`);
                        if (si) lines.push(`í˜ë“  ì •ë„: ${si.emoji} ${si.label}`);
                        lines.push(`ìƒí™©: ${getActivityLabel(r.activity)}`);
                        if (r.durationSeconds) lines.push(`ì§€ì†ì‹œê°„: ${formatDuration(r.durationSeconds)}`);
                        if (r.memo) lines.push(`ë©”ëª¨: ${r.memo}`);
                        lines.push('');
                    });
                }
                const text = lines.join('\n');
                navigator.clipboard.writeText(text).then(() => { setCopied(true); setTimeout(() => setCopied(false), 2000); })
                .catch(() => { const ta = document.createElement('textarea'); ta.value = text; document.body.appendChild(ta); ta.select(); document.execCommand('copy'); document.body.removeChild(ta); setCopied(true); setTimeout(() => setCopied(false), 2000); });
            };

            const barLabels = period === 'week' ? ['ì›”','í™”','ìˆ˜','ëª©','ê¸ˆ','í† ','ì¼'] : dailyCounts.map((_,i) => `${i+1}ì£¼`);

            return (
                <div style={{ minHeight: '100dvh', maxWidth: 500, margin: '0 auto', padding: '24px 20px 100px', animation: 'fadeIn 0.4s ease', position: 'relative', zIndex: 1 }}>
                    <h2 style={{ fontSize: 26, fontWeight: 800, marginBottom: 20 }}>í†µê³„</h2>
                    <div style={{ display: 'flex', background: 'rgba(0,0,0,0.04)', borderRadius: 16, padding: 4, marginBottom: 24 }}>
                        {['week','month'].map(p => (
                            <button key={p} onClick={() => setPeriod(p)} style={{
                                flex: 1, padding: '11px', borderRadius: 14,
                                background: period === p ? '#fff' : 'transparent',
                                boxShadow: period === p ? 'var(--shadow-md)' : 'none',
                                fontSize: 15, fontWeight: 700,
                                color: period === p ? 'var(--primary)' : 'var(--text-sub)',
                                transition: 'all 0.25s'
                            }}>{p === 'week' ? 'ì´ë²ˆ ì£¼' : 'ì´ë²ˆ ë‹¬'}</button>
                        ))}
                    </div>

                    <div className="glass-card" style={{ padding: 24, marginBottom: 16, textAlign: 'center' }}>
                        <p style={{ fontSize: 14, color: 'var(--text-sub)', fontWeight: 600, marginBottom: 4 }}>ì´ ê¸°ë¡</p>
                        <p style={{ fontSize: 44, fontWeight: 900, color: 'var(--primary)' }}>{filtered.length}<span style={{ fontSize: 18 }}>ê±´</span></p>
                    </div>

                    <div className="glass-card" style={{ padding: 20, marginBottom: 16 }}>
                        <div style={{ height: 140, display: 'flex', alignItems: 'flex-end', justifyContent: 'space-around', gap: 6, paddingBottom: 4 }}>
                            {dailyCounts.map((count, i) => (
                                <div key={i} style={{ display: 'flex', flexDirection: 'column', alignItems: 'center', gap: 4, flex: 1 }}>
                                    <span style={{ fontSize: 12, fontWeight: 700, color: count > 0 ? 'var(--primary)' : 'var(--text-sub)' }}>{count > 0 ? count : ''}</span>
                                    <div style={{
                                        width: '100%', maxWidth: 32,
                                        height: count > 0 ? `${(count / maxCount) * 100}px` : 4,
                                        borderRadius: 10,
                                        background: count > 0 ? 'linear-gradient(180deg, var(--primary-light), var(--primary))' : 'rgba(0,0,0,0.06)',
                                        animation: `barGrow 0.5s ease ${i * 0.05}s both`,
                                        boxShadow: count > 0 ? '0 2px 8px rgba(255,107,107,0.2)' : 'none'
                                    }} />
                                </div>
                            ))}
                        </div>
                        <div style={{ display: 'flex', justifyContent: 'space-around', marginTop: 8 }}>
                            {barLabels.map((l, i) => <span key={i} style={{ fontSize: 12, color: 'var(--text-sub)', fontWeight: 600, flex: 1, textAlign: 'center' }}>{l}</span>)}
                        </div>
                    </div>

                    {symptomRanking.length > 0 && (
                        <div className="glass-card" style={{ padding: 20, marginBottom: 16 }}>
                            <h3 style={{ fontSize: 15, fontWeight: 800, marginBottom: 14 }}>ë§ì´ ë‚˜íƒ€ë‚˜ëŠ” ì¦ìƒ</h3>
                            {symptomRanking.map(([key, count], i) => (
                                <div key={key} style={{ marginBottom: 12 }}>
                                    <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: 6 }}>
                                        <span style={{ fontSize: 14, fontWeight: 600 }}>{i + 1}. {getSymptomLabel(key)}</span>
                                        <span style={{ fontSize: 13, fontWeight: 700, color: 'var(--primary)' }}>{count}íšŒ</span>
                                    </div>
                                    <div style={{ height: 8, borderRadius: 4, background: 'rgba(0,0,0,0.04)', overflow: 'hidden' }}>
                                        <div style={{ height: '100%', borderRadius: 4, background: 'linear-gradient(90deg, var(--primary-light), var(--primary))', width: `${(count/maxSymptomCount)*100}%`, transition: 'width 0.5s ease' }} />
                                    </div>
                                </div>
                            ))}
                        </div>
                    )}

                    {activityRanking.length > 0 && (
                        <div className="glass-card" style={{ padding: 20, marginBottom: 24 }}>
                            <h3 style={{ fontSize: 15, fontWeight: 800, marginBottom: 14 }}>ë§ì´ ë‚˜íƒ€ë‚˜ëŠ” ìƒí™©</h3>
                            {activityRanking.map(([key, count], i) => (
                                <div key={key} style={{ display: 'flex', justifyContent: 'space-between', marginBottom: 10 }}>
                                    <span style={{ fontSize: 14, fontWeight: 600 }}>{i + 1}. {getActivityLabel(key)}</span>
                                    <span style={{ fontSize: 13, fontWeight: 700, color: 'var(--primary)' }}>{count}íšŒ</span>
                                </div>
                            ))}
                        </div>
                    )}

                    {filtered.length === 0 && (
                        <div style={{ textAlign: 'center', padding: '40px 0', color: 'var(--text-sub)' }}>
                            <p style={{ fontSize: 40, marginBottom: 8 }}>ğŸ“Š</p>
                            <p style={{ fontSize: 15, fontWeight: 600 }}>ì•„ì§ ê¸°ë¡ì´ ì—†ì–´ìš”</p>
                        </div>
                    )}

                    <button onClick={handleExport} className="glass-card" style={{
                        width: '100%', padding: '16px', textAlign: 'center',
                        background: copied ? 'var(--success)' : 'var(--card)',
                        color: copied ? '#fff' : 'var(--primary)',
                        fontSize: 16, fontWeight: 700, transition: 'all 0.3s ease'
                    }}>
                        {copied ? 'âœ“ ë³µì‚¬í–ˆì–´ìš”!' : 'ğŸ“„ ë³‘ì› ê°€ì ¸ê°€ê¸° (ë³µì‚¬)'}
                    </button>
                </div>
            );
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // ì„¤ì •
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        function SettingsScreen({ records }) {
            const [sheetUrl, setSheetUrlState] = useState(() => getSheetUrl());
            const [saved, setSaved] = useState(false);
            const [testResult, setTestResult] = useState('');
            const [showGuide, setShowGuide] = useState(false);

            const handleSaveUrl = () => { setSheetUrl(sheetUrl); setSaved(true); setTimeout(() => setSaved(false), 2000); };
            const handleTest = async () => {
                if (!sheetUrl) { setTestResult('URLì„ ë¨¼ì € ì…ë ¥í•´ì£¼ì„¸ìš”'); return; }
                setTestResult('í…ŒìŠ¤íŠ¸ ì¤‘...');
                try {
                    await fetch(sheetUrl, { method: 'POST', mode: 'no-cors', headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ action: 'test', timestamp: new Date().toISOString(), message: 'ì—°ê²° í…ŒìŠ¤íŠ¸' }) });
                    setTestResult('âœ… ì „ì†¡ ì™„ë£Œ! êµ¬ê¸€ ì‹œíŠ¸ë¥¼ í™•ì¸í•´ë³´ì„¸ìš”');
                } catch (e) { setTestResult('âŒ ì „ì†¡ ì‹¤íŒ¨. URLì„ í™•ì¸í•´ì£¼ì„¸ìš”'); }
            };

            const handleExportBackup = () => {
                const data = JSON.stringify({ version: 2, records, exportedAt: new Date().toISOString() }, null, 2);
                const blob = new Blob([data], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a'); a.href = url; a.download = `heartlog-backup-${new Date().toISOString().slice(0,10)}.json`; a.click();
                URL.revokeObjectURL(url);
            };

            const handleImportBackup = () => {
                const input = document.createElement('input'); input.type = 'file'; input.accept = '.json';
                input.onchange = (e) => {
                    const file = e.target.files[0]; if (!file) return;
                    const reader = new FileReader();
                    reader.onload = (ev) => {
                        try {
                            const data = JSON.parse(ev.target.result);
                            if (data.records && Array.isArray(data.records)) {
                                localStorage.setItem(STORAGE_KEY, JSON.stringify({ version: 2, records: data.records }));
                                alert(`${data.records.length}ê±´ì˜ ê¸°ë¡ì„ ë¶ˆëŸ¬ì™”ì–´ìš”! ìƒˆë¡œê³ ì¹¨í•©ë‹ˆë‹¤.`);
                                location.reload();
                            } else alert('ì˜¬ë°”ë¥¸ ë°±ì—… íŒŒì¼ì´ ì•„ë‹™ë‹ˆë‹¤.');
                        } catch { alert('íŒŒì¼ì„ ì½ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.'); }
                    };
                    reader.readAsText(file);
                };
                input.click();
            };

            return (
                <div style={{ minHeight: '100dvh', maxWidth: 500, margin: '0 auto', padding: '24px 20px 100px', animation: 'fadeIn 0.4s ease', position: 'relative', zIndex: 1 }}>
                    <h2 style={{ fontSize: 26, fontWeight: 800, marginBottom: 24 }}>ì„¤ì •</h2>

                    <div className="glass-card" style={{ padding: 20, marginBottom: 16 }}>
                        <h3 style={{ fontSize: 16, fontWeight: 800, marginBottom: 6 }}>â˜ï¸ êµ¬ê¸€ ì‹œíŠ¸ ë™ê¸°í™”</h3>
                        <p style={{ fontSize: 13, color: 'var(--text-sub)', marginBottom: 16, lineHeight: 1.6 }}>ê¸°ë¡ì´ ìë™ìœ¼ë¡œ êµ¬ê¸€ ìŠ¤í”„ë ˆë“œì‹œíŠ¸ì— ì €ì¥ë¼ìš”.<br/>ë¶€ëª¨ë‹˜ì´ ì•„ë˜ ì„¤ì •ì„ ë„ì™€ì£¼ì„¸ìš”.</p>
                        <input type="url" value={sheetUrl} onChange={e => setSheetUrlState(e.target.value)} placeholder="Apps Script URLì„ ë¶™ì—¬ë„£ê¸°"
                            style={{ width: '100%', padding: '14px 16px', borderRadius: 16, border: '2px solid rgba(0,0,0,0.06)', fontSize: 14, fontFamily: 'inherit', marginBottom: 10, background: 'rgba(255,255,255,0.9)', color: 'var(--text)' }} />
                        <div style={{ display: 'flex', gap: 8, marginBottom: 10 }}>
                            <button onClick={handleSaveUrl} style={{ flex: 1, padding: '13px', borderRadius: 16, background: saved ? 'var(--success)' : 'var(--primary)', color: '#fff', fontSize: 14, fontWeight: 700, boxShadow: '0 4px 16px rgba(255,107,107,0.2)' }}>{saved ? 'âœ“ ì €ì¥ë¨' : 'ì €ì¥'}</button>
                            <button onClick={handleTest} style={{ flex: 1, padding: '13px', borderRadius: 16, background: 'rgba(0,0,0,0.04)', color: 'var(--primary)', fontSize: 14, fontWeight: 700 }}>í…ŒìŠ¤íŠ¸</button>
                        </div>
                        {testResult && <p style={{ fontSize: 13, color: testResult.includes('âœ…') ? 'var(--success)' : testResult.includes('âŒ') ? '#e74c3c' : 'var(--text-sub)', fontWeight: 600 }}>{testResult}</p>}
                    </div>

                    <div className="glass-card" style={{ padding: 20, marginBottom: 16 }}>
                        <button onClick={() => setShowGuide(!showGuide)} style={{ width: '100%', textAlign: 'left', display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                            <h3 style={{ fontSize: 16, fontWeight: 800 }}>ğŸ“– êµ¬ê¸€ ì‹œíŠ¸ ì„¤ì • ë°©ë²•</h3>
                            <span style={{ fontSize: 16, color: 'var(--text-sub)' }}>{showGuide ? 'â–²' : 'â–¼'}</span>
                        </button>
                        {showGuide && (
                            <div style={{ marginTop: 14, fontSize: 14, lineHeight: 1.8, color: 'var(--text)' }}>
                                <p><strong>1.</strong> êµ¬ê¸€ ë“œë¼ì´ë¸Œì—ì„œ ìƒˆ ìŠ¤í”„ë ˆë“œì‹œíŠ¸ ë§Œë“¤ê¸°</p>
                                <p><strong>2.</strong> ë©”ë‰´ â†’ í™•ì¥ í”„ë¡œê·¸ë¨ â†’ Apps Script</p>
                                <p><strong>3.</strong> ì½”ë“œ ì „ì²´ ì§€ìš°ê³  ì•„ë˜ ì½”ë“œ ë¶™ì—¬ë„£ê¸°:</p>
                                <div style={{ background: 'var(--bg-sub)', borderRadius: 14, padding: 14, margin: '8px 0', fontSize: 11, fontFamily: 'monospace', overflowX: 'auto', whiteSpace: 'pre-wrap', wordBreak: 'break-all' }}>
{`function doPost(e) {
  var sheet = SpreadsheetApp.getActiveSpreadsheet().getActiveSheet();
  var data = JSON.parse(e.postData.contents);
  if (data.action === 'test') {
    sheet.appendRow(['í…ŒìŠ¤íŠ¸', new Date(), 'ì—°ê²° ì„±ê³µ!']);
    return ContentService.createTextOutput('ok');
  }
  if (data.action === 'add') {
    sheet.appendRow([data.date, data.time, data.symptoms,
      data.severity, data.activity, data.duration,
      data.memo, data.timestamp]);
  }
  return ContentService.createTextOutput('ok');
}
function doGet(e) {
  return ContentService.createTextOutput('Heart Log API');
}`}
                                </div>
                                <p><strong>4.</strong> ë°°í¬ â†’ ìƒˆ ë°°í¬ â†’ ìœ í˜•: ì›¹ ì•±</p>
                                <p><strong>5.</strong> ì•¡ì„¸ìŠ¤ ê¶Œí•œ: "ëª¨ë“  ì‚¬ìš©ì" ì„ íƒ</p>
                                <p><strong>6.</strong> ë°°í¬ â†’ URL ë³µì‚¬ â†’ ìœ„ ì…ë ¥ì¹¸ì— ë¶™ì—¬ë„£ê¸°</p>
                            </div>
                        )}
                    </div>

                    <div className="glass-card" style={{ padding: 20, marginBottom: 16 }}>
                        <h3 style={{ fontSize: 16, fontWeight: 800, marginBottom: 14 }}>ğŸ’¾ ë°±ì—… / ë³µì›</h3>
                        <p style={{ fontSize: 13, color: 'var(--text-sub)', marginBottom: 14, lineHeight: 1.5 }}>ê¸°ë¡ì„ íŒŒì¼ë¡œ ë‚´ë³´ë‚´ê±°ë‚˜, íŒŒì¼ì—ì„œ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ìˆì–´ìš”.</p>
                        <div style={{ display: 'flex', gap: 8 }}>
                            <button onClick={handleExportBackup} style={{ flex: 1, padding: '14px', borderRadius: 16, background: 'rgba(0,0,0,0.04)', color: 'var(--primary)', fontSize: 14, fontWeight: 700 }}>ğŸ“¤ ë‚´ë³´ë‚´ê¸°</button>
                            <button onClick={handleImportBackup} style={{ flex: 1, padding: '14px', borderRadius: 16, background: 'rgba(0,0,0,0.04)', color: 'var(--primary)', fontSize: 14, fontWeight: 700 }}>ğŸ“¥ ë¶ˆëŸ¬ì˜¤ê¸°</button>
                        </div>
                    </div>

                    <div className="glass-card" style={{ padding: 20, textAlign: 'center' }}>
                        <p style={{ fontSize: 14, color: 'var(--text-sub)' }}>Heart Log v2.0</p>
                        <p style={{ fontSize: 13, color: 'var(--text-sub)', marginTop: 4 }}>ì´ ê¸°ë¡: {records.length}ê±´</p>
                    </div>
                </div>
            );
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // App
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        function App() {
            const [activeTab, setActiveTab] = useState('home');
            const [isRecording, setIsRecording] = useState(false);
            const [records, setRecords] = useState(() => loadRecords());
            const [toast, setToast] = useState({ show: false, message: '' });
            const [timerRunning, setTimerRunning] = useState(false);
            const [timerStart, setTimerStart] = useState(null);
            const [timerElapsed, setTimerElapsed] = useState(0);
            const timerRef = useRef(null);

            useEffect(() => {
                if (timerRunning && timerStart) {
                    timerRef.current = setInterval(() => setTimerElapsed(Date.now() - timerStart), 200);
                    return () => clearInterval(timerRef.current);
                }
            }, [timerRunning, timerStart]);

            useEffect(() => { saveRecords(records); }, [records]);

            const todayCount = records.filter(r => isSameDay(r.timestamp, new Date())).length;

            const handleSave = async (newRecord) => {
                setRecords(prev => [newRecord, ...prev]);
                setIsRecording(false);
                if (timerRunning) { setTimerRunning(false); clearInterval(timerRef.current); }
                setTimerElapsed(0); setTimerStart(null);
                const syncResult = await syncToSheet(newRecord);
                setToast({ show: true, message: syncResult.ok ? 'ì €ì¥í–ˆì–´ìš”! ğŸ’“ (â˜ï¸ ë™ê¸°í™” ì™„ë£Œ)' : 'ì €ì¥í–ˆì–´ìš”! ğŸ’“' });
                setTimeout(() => setToast({ show: false, message: '' }), 2500);
            };

            const handleDelete = (id) => {
                setRecords(prev => prev.filter(r => r.id !== id));
                syncDeleteToSheet(id);
                setToast({ show: true, message: 'ì‚­ì œí–ˆì–´ìš”' });
                setTimeout(() => setToast({ show: false, message: '' }), 2000);
            };

            return (
                <div>
                    <Toast message={toast.message} show={toast.show} />
                    {activeTab === 'home' && <MainScreen todayCount={todayCount} onAlarm={() => setIsRecording(true)} timerRunning={timerRunning} timerElapsed={timerElapsed} onTimerStart={() => { setTimerStart(Date.now()); setTimerRunning(true); setTimerElapsed(0); }} onTimerStop={() => { setTimerRunning(false); clearInterval(timerRef.current); }} />}
                    {activeTab === 'history' && <RecordScreen records={records} onDeleteRecord={handleDelete} />}
                    {activeTab === 'stats' && <StatsScreen records={records} />}
                    {activeTab === 'settings' && <SettingsScreen records={records} />}
                    <SymptomRecordPanel isOpen={isRecording} onClose={() => setIsRecording(false)} onSave={handleSave} timerElapsed={timerElapsed > 0 ? timerElapsed : null} />
                    <TabBar activeTab={activeTab} onTabChange={setActiveTab} />
                </div>
            );
        }

        ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
</body>
</html>
