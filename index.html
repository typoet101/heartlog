<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>Heart Log | ì‹¬ì¥ ê¸°ë¡</title>

    <!-- PWA: ì•„ì´í° í™ˆí™”ë©´ ì•± ì„¤ì • -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="ì‹¬ì¥ê¸°ë¡">
    <meta name="theme-color" content="#FFF5F0">
    <link rel="apple-touch-icon" sizes="180x180" href="icon-180.png">
    <link rel="apple-touch-icon" sizes="192x192" href="icon-192.png">
    <link rel="icon" type="image/png" sizes="192x192" href="icon-192.png">
    <link rel="manifest" href="manifest.json">

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css">
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        :root {
            --bg: #FFF5F0;
            --bg-sub: #FFF0E8;
            --primary: #F08C6A;
            --primary-light: #FFB49A;
            --primary-dark: #D6714E;
            --primary-glow: rgba(240, 140, 106, 0.25);
            --card: #FFFFFF;
            --success: #6DD4B8;
            --text: #3D2B2B;
            --text-sub: #A3877B;
            --border: #F0E0D8;
            --sev1: #89CFF0;
            --sev2: #FFE066;
            --sev3: #FFB5A7;
            --sev4: #E8A0BF;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Pretendard', -apple-system, sans-serif;
            background: var(--bg);
            color: var(--text);
            -webkit-font-smoothing: antialiased;
            -webkit-text-size-adjust: 100%;
            overflow-x: hidden;
        }

        @keyframes pulse {
            0%   { box-shadow: 0 8px 32px var(--primary-glow), 0 0 0 0 var(--primary-glow); }
            50%  { box-shadow: 0 8px 32px var(--primary-glow), 0 0 0 18px rgba(240, 140, 106, 0); }
            100% { box-shadow: 0 8px 32px var(--primary-glow), 0 0 0 0 var(--primary-glow); }
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(16px); }
            to   { opacity: 1; transform: translateY(0); }
        }

        @keyframes slideUp {
            from { transform: translateY(100%); }
            to   { transform: translateY(0); }
        }

        @keyframes slideDown {
            from { transform: translateY(0); }
            to   { transform: translateY(100%); }
        }

        @keyframes chipPop {
            0%   { transform: scale(1); }
            50%  { transform: scale(1.08); }
            100% { transform: scale(1); }
        }

        @keyframes barGrow {
            from { height: 0; }
        }

        @keyframes toastIn {
            from { opacity: 0; transform: translateY(-20px); }
            to   { opacity: 1; transform: translateY(0); }
        }

        @keyframes toastOut {
            from { opacity: 1; transform: translateY(0); }
            to   { opacity: 0; transform: translateY(-20px); }
        }

        button {
            cursor: pointer;
            border: none;
            background: none;
            font-family: inherit;
            -webkit-tap-highlight-color: transparent;
        }

        button:focus-visible { outline: 3px solid var(--primary-light); outline-offset: 2px; }
        input:focus-visible, textarea:focus-visible { outline: 3px solid var(--primary-light); outline-offset: 2px; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useCallback } = React;

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // ìƒìˆ˜ ì •ì˜
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        const SYMPTOMS = [
            { key: 'palpitation', label: 'ë‘ê·¼ê±°ë¦¼',  icon: 'ğŸ’“' },
            { key: 'chest_tight', label: 'ê°€ìŠ´ ë‹µë‹µ', icon: 'ğŸ˜¤' },
            { key: 'dizzy',       label: 'ì–´ì§€ëŸ¬ì›€',  icon: 'ğŸ˜µâ€ğŸ’«' },
            { key: 'breathless',  label: 'ìˆ¨ì´ ì°¸',   icon: 'ğŸ˜®â€ğŸ’¨' },
            { key: 'chest_pain',  label: 'ê°€ìŠ´ í†µì¦', icon: 'ğŸ˜–' },
            { key: 'other',       label: 'ê¸°íƒ€',      icon: 'ğŸ“' }
        ];

        const SEVERITIES = [
            { value: 1, emoji: 'ğŸ˜Š', label: 'ê´œì°®ì•„',     color: 'var(--sev1)' },
            { value: 2, emoji: 'ğŸ˜', label: 'ì¢€ ë¶ˆí¸í•´',   color: 'var(--sev2)' },
            { value: 3, emoji: 'ğŸ˜£', label: 'í˜ë“¤ì–´',     color: 'var(--sev3)' },
            { value: 4, emoji: 'ğŸ˜°', label: 'ë§ì´ í˜ë“¤ì–´', color: 'var(--sev4)' }
        ];

        const ACTIVITIES = [
            { key: 'rest',     label: 'ê°€ë§Œíˆ ìˆìŒ', icon: 'ğŸ§˜' },
            { key: 'walking',  label: 'ê±·ëŠ” ì¤‘',    icon: 'ğŸš¶' },
            { key: 'running',  label: 'ë›°ëŠ” ì¤‘',    icon: 'ğŸƒ' },
            { key: 'exercise', label: 'ìš´ë™ ì¤‘',    icon: 'âš½' },
            { key: 'sleeping', label: 'ì ìëŠ” ì¤‘',  icon: 'ğŸ˜´' },
            { key: 'class',    label: 'ìˆ˜ì—… ì¤‘',    icon: 'ğŸ“š' }
        ];

        const DAYS_KO = ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '];
        const STORAGE_KEY = 'heartlog_records';

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // ë°ì´í„° ë ˆì´ì–´
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        function loadRecords() {
            try {
                const raw = localStorage.getItem(STORAGE_KEY);
                if (!raw) return [];
                const data = JSON.parse(raw);
                return data.records || [];
            } catch { return []; }
        }

        function saveRecords(records) {
            localStorage.setItem(STORAGE_KEY, JSON.stringify({ version: 2, records }));
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // Google Sheets í´ë¼ìš°ë“œ ë™ê¸°í™”
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        const SHEET_URL_KEY = 'heartlog_sheet_url';

        function getSheetUrl() {
            return localStorage.getItem(SHEET_URL_KEY) || '';
        }

        function setSheetUrl(url) {
            localStorage.setItem(SHEET_URL_KEY, url);
        }

        async function syncToSheet(record) {
            const url = getSheetUrl();
            if (!url) return { ok: false, reason: 'no_url' };
            try {
                const sevInfo = getSeverityInfo(record.severity);
                const body = {
                    action: 'add',
                    timestamp: record.timestamp,
                    date: new Date(record.timestamp).toLocaleDateString('ko-KR'),
                    time: formatTime(record.timestamp),
                    symptoms: record.symptoms.map(getSymptomLabel).join(', '),
                    severity: sevInfo ? `${sevInfo.emoji} ${sevInfo.label}` : '',
                    activity: getActivityLabel(record.activity),
                    duration: record.durationSeconds ? formatDuration(record.durationSeconds) : '',
                    memo: record.memo || ''
                };
                const res = await fetch(url, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body)
                });
                return { ok: true };
            } catch (e) {
                console.log('Sheet sync failed:', e);
                return { ok: false, reason: 'network' };
            }
        }

        async function syncDeleteToSheet(recordId) {
            const url = getSheetUrl();
            if (!url) return;
            try {
                await fetch(url, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action: 'delete', id: recordId })
                });
            } catch (e) {
                console.log('Sheet delete sync failed:', e);
            }
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // ìœ í‹¸ í•¨ìˆ˜
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        function formatDate(d) {
            const date = new Date(d);
            return `${date.getMonth() + 1}ì›” ${date.getDate()}ì¼ ${DAYS_KO[date.getDay()]}ìš”ì¼`;
        }

        function formatTime(d) {
            const date = new Date(d);
            return `${String(date.getHours()).padStart(2,'0')}:${String(date.getMinutes()).padStart(2,'0')}`;
        }

        function formatDateShort(d) {
            const date = new Date(d);
            return `${date.getMonth() + 1}ì›” ${date.getDate()}ì¼ (${DAYS_KO[date.getDay()]})`;
        }

        function formatDuration(sec) {
            if (!sec) return null;
            const m = Math.floor(sec / 60);
            const s = sec % 60;
            return m > 0 ? `${m}ë¶„ ${s}ì´ˆ` : `${s}ì´ˆ`;
        }

        function isSameDay(d1, d2) {
            const a = new Date(d1), b = new Date(d2);
            return a.getFullYear() === b.getFullYear() && a.getMonth() === b.getMonth() && a.getDate() === b.getDate();
        }

        function getSymptomLabel(key) {
            return SYMPTOMS.find(s => s.key === key)?.label || key;
        }

        function getActivityLabel(key) {
            return ACTIVITIES.find(a => a.key === key)?.label || key;
        }

        function getSeverityInfo(val) {
            return SEVERITIES.find(s => s.value === val);
        }

        function vibrate() {
            if (navigator.vibrate) navigator.vibrate(50);
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // í† ìŠ¤íŠ¸ ì»´í¬ë„ŒíŠ¸
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        function Toast({ message, show }) {
            if (!show) return null;
            return (
                <div style={{
                    position: 'fixed', top: 60, left: '50%', transform: 'translateX(-50%)',
                    background: 'var(--success)', color: '#fff', padding: '12px 28px',
                    borderRadius: 16, fontSize: 16, fontWeight: 700, zIndex: 200,
                    animation: 'toastIn 0.3s ease',
                    boxShadow: '0 4px 20px rgba(109,212,184,0.3)'
                }}>
                    {message}
                </div>
            );
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // íƒ­ë°” ì»´í¬ë„ŒíŠ¸
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        function TabBar({ activeTab, onTabChange }) {
            const tabs = [
                { key: 'home', label: 'í™ˆ', icon: 'ğŸ ' },
                { key: 'history', label: 'ê¸°ë¡', icon: 'ğŸ“‹' },
                { key: 'stats', label: 'í†µê³„', icon: 'ğŸ“Š' },
                { key: 'settings', label: 'ì„¤ì •', icon: 'âš™ï¸' }
            ];
            return (
                <nav style={{
                    position: 'fixed', bottom: 0, left: 0, right: 0,
                    background: '#fff', borderTop: '1px solid var(--border)',
                    display: 'flex', height: 64,
                    paddingBottom: 'env(safe-area-inset-bottom)',
                    zIndex: 50
                }}>
                    {tabs.map(t => (
                        <button key={t.key} onClick={() => onTabChange(t.key)} style={{
                            flex: 1, display: 'flex', flexDirection: 'column',
                            alignItems: 'center', justifyContent: 'center', gap: 2,
                            color: activeTab === t.key ? 'var(--primary)' : 'var(--text-sub)',
                            fontSize: 11, fontWeight: activeTab === t.key ? 800 : 500,
                            transition: 'color 0.2s'
                        }}>
                            <span style={{ fontSize: 22 }}>{t.icon}</span>
                            <span>{t.label}</span>
                        </button>
                    ))}
                </nav>
            );
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // ë©”ì¸ í™”ë©´
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        function MainScreen({ todayCount, onAlarm, timerRunning, timerElapsed, onTimerStart, onTimerStop }) {
            const now = new Date();
            const timerDisplay = useCallback(() => {
                const totalSec = Math.floor(timerElapsed / 1000);
                const m = String(Math.floor(totalSec / 60)).padStart(2, '0');
                const s = String(totalSec % 60).padStart(2, '0');
                return `${m}:${s}`;
            }, [timerElapsed]);

            return (
                <div style={{
                    minHeight: '100vh', minHeight: '100dvh',
                    display: 'flex', flexDirection: 'column', alignItems: 'center',
                    paddingTop: 80, paddingBottom: 100,
                    animation: 'fadeIn 0.5s ease'
                }}>
                    {/* ë‚ ì§œ & ì˜¤ëŠ˜ ê¸°ë¡ ìˆ˜ */}
                    <div style={{ textAlign: 'center', marginBottom: 48 }}>
                        <p style={{ fontSize: 15, color: 'var(--text-sub)', fontWeight: 600 }}>
                            {formatDate(now)}
                        </p>
                        <p style={{ fontSize: 22, fontWeight: 800, color: 'var(--primary)', marginTop: 6 }}>
                            ì˜¤ëŠ˜ {todayCount}ê±´
                        </p>
                    </div>

                    {/* í° ì•ŒëŒ ë²„íŠ¼ */}
                    <button
                        onClick={() => { vibrate(); onAlarm(); }}
                        style={{
                            width: 160, height: 160, borderRadius: '50%',
                            background: 'radial-gradient(circle at 40% 40%, var(--primary-light) 0%, var(--primary) 60%, var(--primary-dark) 100%)',
                            color: '#fff', display: 'flex', flexDirection: 'column',
                            alignItems: 'center', justifyContent: 'center', gap: 6,
                            animation: 'pulse 2.5s ease-in-out infinite',
                            transition: 'transform 0.15s ease',
                            border: 'none'
                        }}
                        onTouchStart={e => e.currentTarget.style.transform = 'scale(0.92)'}
                        onTouchEnd={e => e.currentTarget.style.transform = 'scale(1)'}
                        onMouseDown={e => e.currentTarget.style.transform = 'scale(0.92)'}
                        onMouseUp={e => e.currentTarget.style.transform = 'scale(1)'}
                    >
                        <span style={{ fontSize: 36 }}>ğŸ’“</span>
                        <span style={{ fontSize: 18, fontWeight: 800 }}>ê¸°ë¡í•˜ê¸°</span>
                    </button>

                    {/* ì•ˆë‚´ ë¬¸êµ¬ */}
                    <p style={{ marginTop: 20, fontSize: 15, color: 'var(--text-sub)', fontWeight: 500 }}>
                        ë‘ê·¼ê±°ë¦´ ë•Œ ëˆŒëŸ¬ì£¼ì„¸ìš”
                    </p>

                    {/* íƒ€ì´ë¨¸ */}
                    <div style={{
                        marginTop: 48, display: 'flex', alignItems: 'center', gap: 16,
                        background: 'var(--card)', borderRadius: 20, padding: '14px 24px',
                        boxShadow: '0 2px 12px rgba(0,0,0,0.04)'
                    }}>
                        {!timerRunning ? (
                            <button onClick={onTimerStart} style={{
                                padding: '10px 20px', borderRadius: 14,
                                background: 'var(--bg-sub)', color: 'var(--primary)',
                                fontSize: 15, fontWeight: 700
                            }}>ì‹œì‘</button>
                        ) : (
                            <button onClick={onTimerStop} style={{
                                padding: '10px 20px', borderRadius: 14,
                                background: 'var(--primary)', color: '#fff',
                                fontSize: 15, fontWeight: 700
                            }}>ë©ˆì¶”ê¸°</button>
                        )}
                        <span style={{
                            fontSize: 24, fontWeight: 800, fontVariantNumeric: 'tabular-nums',
                            color: timerRunning ? 'var(--primary)' : 'var(--text-sub)',
                            minWidth: 72, textAlign: 'center'
                        }}>
                            {timerDisplay()}
                        </span>
                    </div>
                    <p style={{ marginTop: 8, fontSize: 13, color: 'var(--text-sub)' }}>
                        ì¦ìƒ ì§€ì† ì‹œê°„ ì¸¡ì •
                    </p>
                </div>
            );
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // ì¦ìƒ ê¸°ë¡ íŒ¨ë„
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        function SymptomRecordPanel({ isOpen, onClose, onSave, timerElapsed }) {
            const [symptoms, setSymptoms] = useState([]);
            const [severity, setSeverity] = useState(null);
            const [activity, setActivity] = useState(null);
            const [memo, setMemo] = useState('');
            const [timestamp] = useState(() => new Date().toISOString());
            const [saving, setSaving] = useState(false);
            const [error, setError] = useState('');
            const panelRef = useRef(null);

            useEffect(() => {
                if (isOpen) {
                    setSymptoms([]); setSeverity(null); setActivity(null);
                    setMemo(''); setSaving(false); setError('');
                }
            }, [isOpen]);

            const toggleSymptom = (key) => {
                setError('');
                setSymptoms(prev => prev.includes(key) ? prev.filter(k => k !== key) : [...prev, key]);
            };

            const handleSave = () => {
                if (symptoms.length === 0) { setError('ì¦ìƒì„ ì„ íƒí•´ì£¼ì„¸ìš”'); return; }
                setSaving(true);
                vibrate();
                const durationSeconds = timerElapsed ? Math.floor(timerElapsed / 1000) : null;
                setTimeout(() => {
                    onSave({
                        id: crypto.randomUUID ? crypto.randomUUID() : Date.now().toString(36) + Math.random().toString(36).slice(2),
                        timestamp,
                        symptoms,
                        severity: severity || 1,
                        activity: activity || 'rest',
                        durationSeconds,
                        memo
                    });
                }, 500);
            };

            if (!isOpen) return null;

            const chipStyle = (selected) => ({
                display: 'inline-flex', alignItems: 'center', gap: 6,
                padding: '12px 18px', borderRadius: 18,
                border: `2px solid ${selected ? 'var(--primary)' : 'var(--border)'}`,
                background: selected ? 'var(--primary)' : '#fff',
                color: selected ? '#fff' : 'var(--text)',
                fontSize: 15, fontWeight: 600,
                transition: 'all 0.2s ease',
                animation: selected ? 'chipPop 0.25s ease' : 'none'
            });

            return (
                <div style={{
                    position: 'fixed', inset: 0, zIndex: 100,
                    background: '#fff',
                    animation: 'slideUp 0.35s cubic-bezier(0.33, 1, 0.68, 1)',
                    overflowY: 'auto', WebkitOverflowScrolling: 'touch'
                }} ref={panelRef}>
                    <div style={{ maxWidth: 500, margin: '0 auto', padding: '20px 20px 40px' }}>
                        {/* í—¤ë” */}
                        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: 28 }}>
                            <button onClick={onClose} style={{
                                width: 44, height: 44, borderRadius: 14,
                                background: 'var(--bg-sub)', display: 'flex',
                                alignItems: 'center', justifyContent: 'center', fontSize: 20
                            }}>âœ•</button>
                            <span style={{ fontSize: 15, color: 'var(--text-sub)', fontWeight: 600 }}>
                                ê¸°ë¡ ì¤‘ Â· {formatTime(timestamp)}
                            </span>
                        </div>

                        {/* 1. ì¦ìƒ ì„ íƒ */}
                        <section style={{ marginBottom: 28 }}>
                            <h3 style={{ fontSize: 16, fontWeight: 800, marginBottom: 12, color: 'var(--text)' }}>
                                1. ì–´ë–¤ ì¦ìƒì´ì•¼? <span style={{ fontSize: 13, fontWeight: 500, color: 'var(--text-sub)' }}>(ì—¬ëŸ¬ ê°œ ê°€ëŠ¥)</span>
                            </h3>
                            {error && <p style={{ color: '#e74c3c', fontSize: 14, fontWeight: 600, marginBottom: 8 }}>{error}</p>}
                            <div style={{ display: 'flex', flexWrap: 'wrap', gap: 10 }}>
                                {SYMPTOMS.map(s => (
                                    <button key={s.key} onClick={() => toggleSymptom(s.key)}
                                        style={chipStyle(symptoms.includes(s.key))}>
                                        <span>{s.icon}</span> {s.label}
                                    </button>
                                ))}
                            </div>
                        </section>

                        {/* 2. ê°•ë„ ì„ íƒ */}
                        <section style={{ marginBottom: 28 }}>
                            <h3 style={{ fontSize: 16, fontWeight: 800, marginBottom: 12 }}>2. ì–¼ë§ˆë‚˜ í˜ë“¤ì–´?</h3>
                            <div style={{ display: 'flex', gap: 10 }}>
                                {SEVERITIES.map(s => (
                                    <button key={s.value} onClick={() => setSeverity(s.value)} style={{
                                        flex: 1, padding: '14px 4px', borderRadius: 18,
                                        border: `2px solid ${severity === s.value ? s.color : 'var(--border)'}`,
                                        background: severity === s.value ? `${s.color}18` : '#fff',
                                        display: 'flex', flexDirection: 'column',
                                        alignItems: 'center', gap: 4,
                                        transform: severity === s.value ? 'scale(1.05)' : 'scale(1)',
                                        transition: 'all 0.2s ease',
                                        boxShadow: severity === s.value ? `0 4px 16px ${s.color}30` : 'none'
                                    }}>
                                        <span style={{ fontSize: 28 }}>{s.emoji}</span>
                                        <span style={{ fontSize: 11, fontWeight: 700, color: 'var(--text-sub)' }}>{s.label}</span>
                                    </button>
                                ))}
                            </div>
                        </section>

                        {/* 3. í™œë™ ìƒíƒœ */}
                        <section style={{ marginBottom: 28 }}>
                            <h3 style={{ fontSize: 16, fontWeight: 800, marginBottom: 12 }}>3. ë­í•˜ê³  ìˆì—ˆì–´?</h3>
                            <div style={{ display: 'flex', flexWrap: 'wrap', gap: 10 }}>
                                {ACTIVITIES.map(a => (
                                    <button key={a.key} onClick={() => setActivity(a.key)}
                                        style={chipStyle(activity === a.key)}>
                                        <span>{a.icon}</span> {a.label}
                                    </button>
                                ))}
                            </div>
                        </section>

                        {/* 4. ë©”ëª¨ */}
                        <section style={{ marginBottom: 32 }}>
                            <h3 style={{ fontSize: 16, fontWeight: 800, marginBottom: 12 }}>
                                4. ë©”ëª¨ <span style={{ fontSize: 13, fontWeight: 500, color: 'var(--text-sub)' }}>(ì„ íƒ)</span>
                            </h3>
                            <textarea
                                value={memo} onChange={e => setMemo(e.target.value)}
                                placeholder="ë” í•˜ê³  ì‹¶ì€ ë§ì´ ìˆìœ¼ë©´ ì ì–´ì¤˜"
                                style={{
                                    width: '100%', height: 80, borderRadius: 16,
                                    border: '2px solid var(--border)', padding: 14,
                                    fontSize: 15, fontFamily: 'inherit', resize: 'none',
                                    background: '#fff', color: 'var(--text)'
                                }}
                            />
                        </section>

                        {/* ì €ì¥ ë²„íŠ¼ */}
                        <button onClick={handleSave} disabled={saving} style={{
                            width: '100%', height: 60, borderRadius: 20,
                            background: saving ? 'var(--success)' : 'linear-gradient(135deg, var(--primary-light), var(--primary))',
                            color: '#fff', fontSize: 18, fontWeight: 800,
                            transition: 'all 0.3s ease',
                            boxShadow: '0 4px 20px var(--primary-glow)'
                        }}>
                            {saving ? 'âœ“ ì €ì¥í–ˆì–´ìš”!' : 'ğŸ’¾ ì €ì¥í•˜ê¸°'}
                        </button>
                    </div>
                </div>
            );
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // ê¸°ë¡ ìƒì„¸ ëª¨ë‹¬
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        function RecordDetailModal({ record, onClose, onDelete }) {
            if (!record) return null;
            const sevInfo = getSeverityInfo(record.severity);
            return (
                <div style={{
                    position: 'fixed', inset: 0, zIndex: 110,
                    background: 'rgba(0,0,0,0.3)',
                    display: 'flex', alignItems: 'flex-end', justifyContent: 'center'
                }} onClick={onClose}>
                    <div style={{
                        background: '#fff', borderRadius: '24px 24px 0 0',
                        width: '100%', maxWidth: 500, padding: '28px 24px 40px',
                        animation: 'slideUp 0.3s ease'
                    }} onClick={e => e.stopPropagation()}>
                        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: 20 }}>
                            <h3 style={{ fontSize: 18, fontWeight: 800 }}>ê¸°ë¡ ìƒì„¸</h3>
                            <button onClick={onClose} style={{
                                width: 40, height: 40, borderRadius: 12,
                                background: 'var(--bg-sub)', fontSize: 18,
                                display: 'flex', alignItems: 'center', justifyContent: 'center'
                            }}>âœ•</button>
                        </div>

                        <p style={{ fontSize: 14, color: 'var(--text-sub)', marginBottom: 16 }}>
                            {formatDateShort(record.timestamp)} {formatTime(record.timestamp)}
                        </p>

                        <div style={{ marginBottom: 14 }}>
                            <p style={{ fontSize: 13, color: 'var(--text-sub)', fontWeight: 600, marginBottom: 6 }}>ì¦ìƒ</p>
                            <div style={{ display: 'flex', flexWrap: 'wrap', gap: 8 }}>
                                {record.symptoms.map(s => (
                                    <span key={s} style={{
                                        padding: '6px 14px', borderRadius: 12,
                                        background: 'var(--bg-sub)', fontSize: 14, fontWeight: 600
                                    }}>{getSymptomLabel(s)}</span>
                                ))}
                            </div>
                        </div>

                        {sevInfo && (
                            <div style={{ marginBottom: 14 }}>
                                <p style={{ fontSize: 13, color: 'var(--text-sub)', fontWeight: 600, marginBottom: 6 }}>í˜ë“  ì •ë„</p>
                                <span style={{ fontSize: 16 }}>{sevInfo.emoji} {sevInfo.label}</span>
                            </div>
                        )}

                        <div style={{ marginBottom: 14 }}>
                            <p style={{ fontSize: 13, color: 'var(--text-sub)', fontWeight: 600, marginBottom: 6 }}>í™œë™</p>
                            <span style={{ fontSize: 16 }}>{getActivityLabel(record.activity)}</span>
                        </div>

                        {record.durationSeconds && (
                            <div style={{ marginBottom: 14 }}>
                                <p style={{ fontSize: 13, color: 'var(--text-sub)', fontWeight: 600, marginBottom: 6 }}>ì§€ì† ì‹œê°„</p>
                                <span style={{ fontSize: 16 }}>{formatDuration(record.durationSeconds)}</span>
                            </div>
                        )}

                        {record.memo && (
                            <div style={{ marginBottom: 14 }}>
                                <p style={{ fontSize: 13, color: 'var(--text-sub)', fontWeight: 600, marginBottom: 6 }}>ë©”ëª¨</p>
                                <p style={{ fontSize: 15, lineHeight: 1.5, background: 'var(--bg-sub)', padding: 14, borderRadius: 14 }}>{record.memo}</p>
                            </div>
                        )}

                        <button onClick={() => onDelete(record.id)} style={{
                            width: '100%', marginTop: 12, padding: '14px', borderRadius: 16,
                            background: '#FFF0ED', color: '#D6714E',
                            fontSize: 15, fontWeight: 700
                        }}>ì‚­ì œí•˜ê¸°</button>
                    </div>
                </div>
            );
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // ê¸°ë¡ ëª©ë¡ í™”ë©´
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        function RecordScreen({ records, onDeleteRecord }) {
            const [currentYear, setCurrentYear] = useState(new Date().getFullYear());
            const [currentMonth, setCurrentMonth] = useState(new Date().getMonth());
            const [selectedRecord, setSelectedRecord] = useState(null);
            const [confirmDelete, setConfirmDelete] = useState(null);

            const filtered = records.filter(r => {
                const d = new Date(r.timestamp);
                return d.getFullYear() === currentYear && d.getMonth() === currentMonth;
            }).sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

            // ë‚ ì§œë³„ ê·¸ë£¹í•‘
            const groups = {};
            filtered.forEach(r => {
                const dateKey = new Date(r.timestamp).toDateString();
                if (!groups[dateKey]) groups[dateKey] = [];
                groups[dateKey].push(r);
            });

            const prevMonth = () => {
                if (currentMonth === 0) { setCurrentMonth(11); setCurrentYear(y => y - 1); }
                else setCurrentMonth(m => m - 1);
            };
            const nextMonth = () => {
                if (currentMonth === 11) { setCurrentMonth(0); setCurrentYear(y => y + 1); }
                else setCurrentMonth(m => m + 1);
            };

            const handleDelete = (id) => {
                setConfirmDelete(id);
            };

            const confirmDeleteAction = () => {
                onDeleteRecord(confirmDelete);
                setConfirmDelete(null);
                setSelectedRecord(null);
            };

            return (
                <div style={{
                    minHeight: '100vh', minHeight: '100dvh',
                    paddingTop: 24, paddingBottom: 100,
                    maxWidth: 500, margin: '0 auto', padding: '24px 20px 100px',
                    animation: 'fadeIn 0.4s ease'
                }}>
                    <h2 style={{ fontSize: 24, fontWeight: 800, marginBottom: 20 }}>ê¸°ë¡ ëª©ë¡</h2>

                    {/* ì›” ë„¤ë¹„ê²Œì´ì…˜ */}
                    <div style={{
                        display: 'flex', justifyContent: 'center', alignItems: 'center',
                        gap: 28, marginBottom: 24
                    }}>
                        <button onClick={prevMonth} style={{
                            width: 44, height: 44, borderRadius: 14,
                            background: 'var(--bg-sub)', fontSize: 18,
                            display: 'flex', alignItems: 'center', justifyContent: 'center'
                        }}>â—€</button>
                        <span style={{ fontSize: 18, fontWeight: 800, minWidth: 80, textAlign: 'center' }}>
                            {currentYear === new Date().getFullYear() ? '' : `${currentYear}ë…„ `}{currentMonth + 1}ì›”
                        </span>
                        <button onClick={nextMonth} style={{
                            width: 44, height: 44, borderRadius: 14,
                            background: 'var(--bg-sub)', fontSize: 18,
                            display: 'flex', alignItems: 'center', justifyContent: 'center'
                        }}>â–¶</button>
                    </div>

                    {/* ê¸°ë¡ì´ ì—†ì„ ë•Œ */}
                    {filtered.length === 0 && (
                        <div style={{ textAlign: 'center', paddingTop: 80, color: 'var(--text-sub)' }}>
                            <p style={{ fontSize: 48, marginBottom: 12 }}>ğŸ“</p>
                            <p style={{ fontSize: 16, fontWeight: 600 }}>ì´ë²ˆ ë‹¬ ê¸°ë¡ì´ ì—†ì–´ìš”</p>
                        </div>
                    )}

                    {/* ë‚ ì§œë³„ ê·¸ë£¹ */}
                    {Object.entries(groups).map(([dateKey, recs]) => (
                        <div key={dateKey} style={{ marginBottom: 20 }}>
                            <div style={{
                                display: 'flex', justifyContent: 'space-between', alignItems: 'center',
                                padding: '8px 0', marginBottom: 8,
                                borderBottom: '1px solid var(--border)'
                            }}>
                                <span style={{ fontSize: 14, fontWeight: 700, color: 'var(--text-sub)' }}>
                                    {formatDateShort(recs[0].timestamp)}
                                </span>
                                <span style={{ fontSize: 13, fontWeight: 600, color: 'var(--primary)' }}>
                                    {recs.length}ê±´
                                </span>
                            </div>

                            {recs.map(r => {
                                const sevInfo = getSeverityInfo(r.severity);
                                return (
                                    <button key={r.id} onClick={() => setSelectedRecord(r)} style={{
                                        width: '100%', textAlign: 'left',
                                        background: 'var(--card)', borderRadius: 18,
                                        padding: '16px 18px', marginBottom: 8,
                                        boxShadow: '0 2px 10px rgba(0,0,0,0.03)',
                                        transition: 'transform 0.15s',
                                        display: 'block'
                                    }}>
                                        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: 6 }}>
                                            <span style={{ fontSize: 13, color: 'var(--text-sub)', fontWeight: 700 }}>
                                                {formatTime(r.timestamp)}
                                            </span>
                                            {r.durationSeconds && (
                                                <span style={{ fontSize: 12, color: 'var(--text-sub)' }}>â± {formatDuration(r.durationSeconds)}</span>
                                            )}
                                        </div>
                                        <p style={{ fontSize: 16, fontWeight: 700, marginBottom: 6 }}>
                                            {r.symptoms.map(getSymptomLabel).join(', ')}
                                        </p>
                                        <div style={{ display: 'flex', gap: 8, flexWrap: 'wrap' }}>
                                            {sevInfo && (
                                                <span style={{
                                                    padding: '4px 10px', borderRadius: 10,
                                                    background: `${sevInfo.color}20`, fontSize: 13, fontWeight: 600
                                                }}>{sevInfo.emoji} {sevInfo.label}</span>
                                            )}
                                            <span style={{
                                                padding: '4px 10px', borderRadius: 10,
                                                background: 'var(--bg-sub)', fontSize: 13, fontWeight: 600
                                            }}>{getActivityLabel(r.activity)}</span>
                                        </div>
                                        {r.memo && (
                                            <p style={{
                                                marginTop: 8, fontSize: 13, color: 'var(--text-sub)',
                                                overflow: 'hidden', textOverflow: 'ellipsis', whiteSpace: 'nowrap'
                                            }}>ğŸ’¬ {r.memo}</p>
                                        )}
                                    </button>
                                );
                            })}
                        </div>
                    ))}

                    <RecordDetailModal record={selectedRecord} onClose={() => setSelectedRecord(null)} onDelete={handleDelete} />

                    {/* ì‚­ì œ í™•ì¸ ëª¨ë‹¬ */}
                    {confirmDelete && (
                        <div style={{
                            position: 'fixed', inset: 0, zIndex: 120,
                            background: 'rgba(0,0,0,0.4)',
                            display: 'flex', alignItems: 'center', justifyContent: 'center'
                        }}>
                            <div style={{
                                background: '#fff', borderRadius: 24, padding: '28px 24px',
                                width: '85%', maxWidth: 320, textAlign: 'center'
                            }}>
                                <p style={{ fontSize: 17, fontWeight: 700, marginBottom: 20 }}>ì´ ê¸°ë¡ì„ ì‚­ì œí• ê¹Œìš”?</p>
                                <div style={{ display: 'flex', gap: 10 }}>
                                    <button onClick={() => setConfirmDelete(null)} style={{
                                        flex: 1, padding: '14px', borderRadius: 14,
                                        background: 'var(--bg-sub)', fontSize: 15, fontWeight: 700, color: 'var(--text-sub)'
                                    }}>ì·¨ì†Œ</button>
                                    <button onClick={confirmDeleteAction} style={{
                                        flex: 1, padding: '14px', borderRadius: 14,
                                        background: '#FFF0ED', fontSize: 15, fontWeight: 700, color: '#D6714E'
                                    }}>ì‚­ì œ</button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // í†µê³„ í™”ë©´
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        function StatsScreen({ records }) {
            const [period, setPeriod] = useState('week');
            const [copied, setCopied] = useState(false);
            const now = new Date();

            // ê¸°ê°„ í•„í„°
            const getStartDate = () => {
                const d = new Date(now);
                if (period === 'week') {
                    const day = d.getDay();
                    d.setDate(d.getDate() - (day === 0 ? 6 : day - 1));
                } else {
                    d.setDate(1);
                }
                d.setHours(0, 0, 0, 0);
                return d;
            };

            const startDate = getStartDate();
            const filtered = records.filter(r => new Date(r.timestamp) >= startDate);

            // ìš”ì¼ë³„ ì¹´ìš´íŠ¸ (ì£¼ê°„)
            const dailyCounts = (() => {
                if (period === 'week') {
                    const counts = [0, 0, 0, 0, 0, 0, 0];
                    filtered.forEach(r => {
                        const d = new Date(r.timestamp);
                        let dayIdx = d.getDay() - 1;
                        if (dayIdx < 0) dayIdx = 6;
                        counts[dayIdx]++;
                    });
                    return counts;
                } else {
                    // ì›”ê°„: ì£¼ì°¨ë³„
                    const daysInMonth = new Date(now.getFullYear(), now.getMonth() + 1, 0).getDate();
                    const weeks = Math.ceil(daysInMonth / 7);
                    const counts = new Array(weeks).fill(0);
                    filtered.forEach(r => {
                        const d = new Date(r.timestamp);
                        const weekIdx = Math.floor((d.getDate() - 1) / 7);
                        if (weekIdx < counts.length) counts[weekIdx]++;
                    });
                    return counts;
                }
            })();

            const maxCount = Math.max(...dailyCounts, 1);

            // ì¦ìƒ ë­í‚¹
            const symptomCounts = {};
            filtered.forEach(r => r.symptoms.forEach(s => { symptomCounts[s] = (symptomCounts[s] || 0) + 1; }));
            const symptomRanking = Object.entries(symptomCounts).sort((a, b) => b[1] - a[1]).slice(0, 5);

            // í™œë™ ë­í‚¹
            const activityCounts = {};
            filtered.forEach(r => { activityCounts[r.activity] = (activityCounts[r.activity] || 0) + 1; });
            const activityRanking = Object.entries(activityCounts).sort((a, b) => b[1] - a[1]).slice(0, 5);
            const maxSymptomCount = symptomRanking.length > 0 ? symptomRanking[0][1] : 1;

            // ë‚´ë³´ë‚´ê¸°
            const handleExport = () => {
                const lines = ['=== ì‹¬ì¥ ê¸°ë¡ (Heart Log) ==='];
                const sortedAll = [...records].sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                if (sortedAll.length === 0) { lines.push('ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.'); }
                else {
                    const first = sortedAll[sortedAll.length - 1];
                    const last = sortedAll[0];
                    lines.push(`ê¸°ê°„: ${new Date(first.timestamp).toLocaleDateString('ko-KR')} ~ ${new Date(last.timestamp).toLocaleDateString('ko-KR')}`);
                    lines.push(`ì´ ê¸°ë¡: ${sortedAll.length}ê±´`);
                    lines.push('');
                    sortedAll.forEach(r => {
                        const sevInfo = getSeverityInfo(r.severity);
                        lines.push('---');
                        lines.push(`${formatDateShort(r.timestamp)} ${formatTime(r.timestamp)}`);
                        lines.push(`ì¦ìƒ: ${r.symptoms.map(getSymptomLabel).join(', ')}`);
                        if (sevInfo) lines.push(`í˜ë“  ì •ë„: ${sevInfo.emoji} ${sevInfo.label}`);
                        lines.push(`ìƒí™©: ${getActivityLabel(r.activity)}`);
                        if (r.durationSeconds) lines.push(`ì§€ì†ì‹œê°„: ${formatDuration(r.durationSeconds)}`);
                        if (r.memo) lines.push(`ë©”ëª¨: ${r.memo}`);
                        lines.push('');
                    });
                }

                const text = lines.join('\n');
                navigator.clipboard.writeText(text).then(() => {
                    setCopied(true);
                    setTimeout(() => setCopied(false), 2000);
                }).catch(() => {
                    // í´ë°±: textareaì—ì„œ ë³µì‚¬
                    const ta = document.createElement('textarea');
                    ta.value = text;
                    document.body.appendChild(ta);
                    ta.select();
                    document.execCommand('copy');
                    document.body.removeChild(ta);
                    setCopied(true);
                    setTimeout(() => setCopied(false), 2000);
                });
            };

            const barLabels = period === 'week'
                ? ['ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† ', 'ì¼']
                : dailyCounts.map((_, i) => `${i + 1}ì£¼`);

            return (
                <div style={{
                    minHeight: '100vh', minHeight: '100dvh',
                    maxWidth: 500, margin: '0 auto', padding: '24px 20px 100px',
                    animation: 'fadeIn 0.4s ease'
                }}>
                    <h2 style={{ fontSize: 24, fontWeight: 800, marginBottom: 20 }}>í†µê³„</h2>

                    {/* ê¸°ê°„ í† ê¸€ */}
                    <div style={{
                        display: 'flex', background: 'var(--bg-sub)', borderRadius: 14, padding: 4, marginBottom: 24
                    }}>
                        {['week', 'month'].map(p => (
                            <button key={p} onClick={() => setPeriod(p)} style={{
                                flex: 1, padding: '10px', borderRadius: 12,
                                background: period === p ? '#fff' : 'transparent',
                                boxShadow: period === p ? '0 2px 8px rgba(0,0,0,0.06)' : 'none',
                                fontSize: 15, fontWeight: 700,
                                color: period === p ? 'var(--primary)' : 'var(--text-sub)',
                                transition: 'all 0.2s'
                            }}>
                                {p === 'week' ? 'ì´ë²ˆ ì£¼' : 'ì´ë²ˆ ë‹¬'}
                            </button>
                        ))}
                    </div>

                    {/* ì´ ê¸°ë¡ */}
                    <div style={{
                        background: '#fff', borderRadius: 22, padding: '24px', marginBottom: 16,
                        boxShadow: '0 2px 12px rgba(0,0,0,0.03)', textAlign: 'center'
                    }}>
                        <p style={{ fontSize: 14, color: 'var(--text-sub)', fontWeight: 600, marginBottom: 4 }}>ì´ ê¸°ë¡</p>
                        <p style={{ fontSize: 40, fontWeight: 900, color: 'var(--primary)' }}>{filtered.length}<span style={{ fontSize: 18 }}>ê±´</span></p>
                    </div>

                    {/* ë§‰ëŒ€ ê·¸ë˜í”„ */}
                    <div style={{
                        background: '#fff', borderRadius: 22, padding: '20px', marginBottom: 16,
                        boxShadow: '0 2px 12px rgba(0,0,0,0.03)'
                    }}>
                        <div style={{
                            height: 140, display: 'flex', alignItems: 'flex-end',
                            justifyContent: 'space-around', gap: 6, paddingBottom: 4
                        }}>
                            {dailyCounts.map((count, i) => (
                                <div key={i} style={{
                                    display: 'flex', flexDirection: 'column', alignItems: 'center', gap: 4, flex: 1
                                }}>
                                    <span style={{ fontSize: 12, fontWeight: 700, color: count > 0 ? 'var(--primary)' : 'var(--text-sub)' }}>
                                        {count > 0 ? count : ''}
                                    </span>
                                    <div style={{
                                        width: '100%', maxWidth: 32,
                                        height: count > 0 ? `${(count / maxCount) * 100}px` : 4,
                                        borderRadius: '8px 8px 0 0',
                                        background: count > 0 ? 'var(--primary)' : 'var(--border)',
                                        animation: `barGrow 0.5s ease ${i * 0.05}s both`,
                                        transition: 'height 0.4s ease'
                                    }} />
                                </div>
                            ))}
                        </div>
                        <div style={{ display: 'flex', justifyContent: 'space-around', marginTop: 8 }}>
                            {barLabels.map((label, i) => (
                                <span key={i} style={{ fontSize: 12, color: 'var(--text-sub)', fontWeight: 600, flex: 1, textAlign: 'center' }}>
                                    {label}
                                </span>
                            ))}
                        </div>
                    </div>

                    {/* ì¦ìƒ ë­í‚¹ */}
                    {symptomRanking.length > 0 && (
                        <div style={{
                            background: '#fff', borderRadius: 22, padding: '20px', marginBottom: 16,
                            boxShadow: '0 2px 12px rgba(0,0,0,0.03)'
                        }}>
                            <h3 style={{ fontSize: 15, fontWeight: 800, marginBottom: 14, color: 'var(--text)' }}>ë§ì´ ë‚˜íƒ€ë‚˜ëŠ” ì¦ìƒ</h3>
                            {symptomRanking.map(([key, count], i) => (
                                <div key={key} style={{ marginBottom: 10 }}>
                                    <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: 4 }}>
                                        <span style={{ fontSize: 14, fontWeight: 600 }}>{i + 1}. {getSymptomLabel(key)}</span>
                                        <span style={{ fontSize: 13, fontWeight: 700, color: 'var(--primary)' }}>{count}íšŒ</span>
                                    </div>
                                    <div style={{ height: 8, borderRadius: 4, background: 'var(--bg-sub)', overflow: 'hidden' }}>
                                        <div style={{
                                            height: '100%', borderRadius: 4,
                                            background: 'var(--primary-light)',
                                            width: `${(count / maxSymptomCount) * 100}%`,
                                            transition: 'width 0.5s ease'
                                        }} />
                                    </div>
                                </div>
                            ))}
                        </div>
                    )}

                    {/* í™œë™ ë­í‚¹ */}
                    {activityRanking.length > 0 && (
                        <div style={{
                            background: '#fff', borderRadius: 22, padding: '20px', marginBottom: 24,
                            boxShadow: '0 2px 12px rgba(0,0,0,0.03)'
                        }}>
                            <h3 style={{ fontSize: 15, fontWeight: 800, marginBottom: 14, color: 'var(--text)' }}>ë§ì´ ë‚˜íƒ€ë‚˜ëŠ” ìƒí™©</h3>
                            {activityRanking.map(([key, count], i) => (
                                <div key={key} style={{ display: 'flex', justifyContent: 'space-between', marginBottom: 8 }}>
                                    <span style={{ fontSize: 14, fontWeight: 600 }}>{i + 1}. {getActivityLabel(key)}</span>
                                    <span style={{ fontSize: 13, fontWeight: 700, color: 'var(--primary)' }}>{count}íšŒ</span>
                                </div>
                            ))}
                        </div>
                    )}

                    {/* ê¸°ë¡ì´ ì—†ì„ ë•Œ */}
                    {filtered.length === 0 && (
                        <div style={{ textAlign: 'center', padding: '40px 0', color: 'var(--text-sub)' }}>
                            <p style={{ fontSize: 40, marginBottom: 8 }}>ğŸ“Š</p>
                            <p style={{ fontSize: 15, fontWeight: 600 }}>ì•„ì§ ê¸°ë¡ì´ ì—†ì–´ìš”</p>
                        </div>
                    )}

                    {/* ë‚´ë³´ë‚´ê¸° ë²„íŠ¼ */}
                    <button onClick={handleExport} style={{
                        width: '100%', padding: '16px', borderRadius: 18,
                        background: copied ? 'var(--success)' : '#fff',
                        border: `2px solid ${copied ? 'var(--success)' : 'var(--primary)'}`,
                        color: copied ? '#fff' : 'var(--primary)',
                        fontSize: 16, fontWeight: 700,
                        transition: 'all 0.3s ease',
                        boxShadow: '0 2px 12px rgba(0,0,0,0.03)'
                    }}>
                        {copied ? 'âœ“ ë³µì‚¬í–ˆì–´ìš”!' : 'ğŸ“„ ë³‘ì› ê°€ì ¸ê°€ê¸° (ë³µì‚¬)'}
                    </button>
                </div>
            );
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // ì„¤ì • í™”ë©´
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        function SettingsScreen({ records }) {
            const [sheetUrl, setSheetUrlState] = useState(() => getSheetUrl());
            const [saved, setSaved] = useState(false);
            const [testResult, setTestResult] = useState('');
            const [showBackupInfo, setShowBackupInfo] = useState(false);

            const handleSaveUrl = () => {
                setSheetUrl(sheetUrl);
                setSaved(true);
                setTimeout(() => setSaved(false), 2000);
            };

            const handleTest = async () => {
                if (!sheetUrl) { setTestResult('URLì„ ë¨¼ì € ì…ë ¥í•´ì£¼ì„¸ìš”'); return; }
                setTestResult('í…ŒìŠ¤íŠ¸ ì¤‘...');
                try {
                    await fetch(sheetUrl, {
                        method: 'POST',
                        mode: 'no-cors',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            action: 'test',
                            timestamp: new Date().toISOString(),
                            message: 'ì—°ê²° í…ŒìŠ¤íŠ¸'
                        })
                    });
                    setTestResult('âœ… ì „ì†¡ ì™„ë£Œ! êµ¬ê¸€ ì‹œíŠ¸ë¥¼ í™•ì¸í•´ë³´ì„¸ìš”');
                } catch (e) {
                    setTestResult('âŒ ì „ì†¡ ì‹¤íŒ¨. URLì„ í™•ì¸í•´ì£¼ì„¸ìš”');
                }
            };

            // ë°±ì—… ë‚´ë³´ë‚´ê¸° (JSON)
            const handleExportBackup = () => {
                const data = JSON.stringify({ version: 2, records, exportedAt: new Date().toISOString() }, null, 2);
                const blob = new Blob([data], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `heartlog-backup-${new Date().toISOString().slice(0,10)}.json`;
                a.click();
                URL.revokeObjectURL(url);
            };

            // ë°±ì—… ë¶ˆëŸ¬ì˜¤ê¸°
            const handleImportBackup = () => {
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = '.json';
                input.onchange = (e) => {
                    const file = e.target.files[0];
                    if (!file) return;
                    const reader = new FileReader();
                    reader.onload = (ev) => {
                        try {
                            const data = JSON.parse(ev.target.result);
                            if (data.records && Array.isArray(data.records)) {
                                localStorage.setItem(STORAGE_KEY, JSON.stringify({ version: 2, records: data.records }));
                                alert(`${data.records.length}ê±´ì˜ ê¸°ë¡ì„ ë¶ˆëŸ¬ì™”ì–´ìš”! ìƒˆë¡œê³ ì¹¨í•©ë‹ˆë‹¤.`);
                                location.reload();
                            } else {
                                alert('ì˜¬ë°”ë¥¸ ë°±ì—… íŒŒì¼ì´ ì•„ë‹™ë‹ˆë‹¤.');
                            }
                        } catch { alert('íŒŒì¼ì„ ì½ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.'); }
                    };
                    reader.readAsText(file);
                };
                input.click();
            };

            return (
                <div style={{
                    minHeight: '100vh', minHeight: '100dvh',
                    maxWidth: 500, margin: '0 auto', padding: '24px 20px 100px',
                    animation: 'fadeIn 0.4s ease'
                }}>
                    <h2 style={{ fontSize: 24, fontWeight: 800, marginBottom: 24 }}>ì„¤ì •</h2>

                    {/* í´ë¼ìš°ë“œ ë™ê¸°í™” */}
                    <div style={{
                        background: '#fff', borderRadius: 22, padding: '20px', marginBottom: 16,
                        boxShadow: '0 2px 12px rgba(0,0,0,0.03)'
                    }}>
                        <h3 style={{ fontSize: 16, fontWeight: 800, marginBottom: 6 }}>â˜ï¸ êµ¬ê¸€ ì‹œíŠ¸ ë™ê¸°í™”</h3>
                        <p style={{ fontSize: 13, color: 'var(--text-sub)', marginBottom: 16, lineHeight: 1.6 }}>
                            ê¸°ë¡ì´ ìë™ìœ¼ë¡œ êµ¬ê¸€ ìŠ¤í”„ë ˆë“œì‹œíŠ¸ì— ì €ì¥ë¼ìš”.<br/>
                            ë¶€ëª¨ë‹˜ì´ ì•„ë˜ ì„¤ì •ì„ ë„ì™€ì£¼ì„¸ìš”.
                        </p>

                        <input
                            type="url"
                            value={sheetUrl}
                            onChange={e => setSheetUrlState(e.target.value)}
                            placeholder="Apps Script URLì„ ë¶™ì—¬ë„£ê¸°"
                            style={{
                                width: '100%', padding: '14px', borderRadius: 14,
                                border: '2px solid var(--border)', fontSize: 14,
                                fontFamily: 'inherit', marginBottom: 10,
                                background: '#fff', color: 'var(--text)'
                            }}
                        />

                        <div style={{ display: 'flex', gap: 8, marginBottom: 10 }}>
                            <button onClick={handleSaveUrl} style={{
                                flex: 1, padding: '12px', borderRadius: 14,
                                background: saved ? 'var(--success)' : 'var(--primary)',
                                color: '#fff', fontSize: 14, fontWeight: 700
                            }}>{saved ? 'âœ“ ì €ì¥ë¨' : 'ì €ì¥'}</button>
                            <button onClick={handleTest} style={{
                                flex: 1, padding: '12px', borderRadius: 14,
                                background: 'var(--bg-sub)', color: 'var(--primary)',
                                fontSize: 14, fontWeight: 700
                            }}>í…ŒìŠ¤íŠ¸</button>
                        </div>

                        {testResult && (
                            <p style={{ fontSize: 13, color: testResult.includes('âœ…') ? 'var(--success)' : testResult.includes('âŒ') ? '#e74c3c' : 'var(--text-sub)', fontWeight: 600 }}>
                                {testResult}
                            </p>
                        )}
                    </div>

                    {/* ì„¤ì • ê°€ì´ë“œ */}
                    <div style={{
                        background: '#fff', borderRadius: 22, padding: '20px', marginBottom: 16,
                        boxShadow: '0 2px 12px rgba(0,0,0,0.03)'
                    }}>
                        <button onClick={() => setShowBackupInfo(!showBackupInfo)} style={{
                            width: '100%', textAlign: 'left', display: 'flex',
                            justifyContent: 'space-between', alignItems: 'center'
                        }}>
                            <h3 style={{ fontSize: 16, fontWeight: 800 }}>ğŸ“– êµ¬ê¸€ ì‹œíŠ¸ ì„¤ì • ë°©ë²•</h3>
                            <span style={{ fontSize: 18 }}>{showBackupInfo ? 'â–²' : 'â–¼'}</span>
                        </button>
                        {showBackupInfo && (
                            <div style={{ marginTop: 14, fontSize: 14, lineHeight: 1.8, color: 'var(--text)' }}>
                                <p><strong>1.</strong> êµ¬ê¸€ ë“œë¼ì´ë¸Œì—ì„œ ìƒˆ ìŠ¤í”„ë ˆë“œì‹œíŠ¸ ë§Œë“¤ê¸°</p>
                                <p><strong>2.</strong> ë©”ë‰´ â†’ í™•ì¥ í”„ë¡œê·¸ë¨ â†’ Apps Script</p>
                                <p><strong>3.</strong> ì½”ë“œ ì „ì²´ ì§€ìš°ê³  ì•„ë˜ ì½”ë“œ ë¶™ì—¬ë„£ê¸°:</p>
                                <div style={{
                                    background: 'var(--bg-sub)', borderRadius: 12, padding: 14,
                                    margin: '8px 0', fontSize: 12, fontFamily: 'monospace',
                                    overflowX: 'auto', whiteSpace: 'pre-wrap', wordBreak: 'break-all'
                                }}>
{`function doPost(e) {
  var sheet = SpreadsheetApp.getActiveSpreadsheet().getActiveSheet();
  var data = JSON.parse(e.postData.contents);

  if (data.action === 'test') {
    sheet.appendRow(['í…ŒìŠ¤íŠ¸', new Date(), 'ì—°ê²° ì„±ê³µ!']);
    return ContentService.createTextOutput('ok');
  }

  if (data.action === 'add') {
    sheet.appendRow([
      data.date,
      data.time,
      data.symptoms,
      data.severity,
      data.activity,
      data.duration,
      data.memo,
      data.timestamp
    ]);
  }

  return ContentService.createTextOutput('ok');
}

function doGet(e) {
  return ContentService.createTextOutput('Heart Log API');
}`}
                                </div>
                                <p><strong>4.</strong> ë°°í¬ â†’ ìƒˆ ë°°í¬ â†’ ìœ í˜•: ì›¹ ì•±</p>
                                <p><strong>5.</strong> ì•¡ì„¸ìŠ¤ ê¶Œí•œ: "ëª¨ë“  ì‚¬ìš©ì" ì„ íƒ</p>
                                <p><strong>6.</strong> ë°°í¬ â†’ URL ë³µì‚¬ â†’ ìœ„ ì…ë ¥ì¹¸ì— ë¶™ì—¬ë„£ê¸°</p>
                                <p style={{ marginTop: 8, color: 'var(--primary)', fontWeight: 700 }}>
                                    ğŸ’¡ ì²« í–‰ì— í—¤ë”ë¥¼ ì¶”ê°€í•˜ë©´ ë” ë³´ê¸° ì¢‹ì•„ìš”:<br/>
                                    ë‚ ì§œ | ì‹œê°„ | ì¦ìƒ | ê°•ë„ | í™œë™ | ì§€ì†ì‹œê°„ | ë©”ëª¨ | íƒ€ì„ìŠ¤íƒ¬í”„
                                </p>
                            </div>
                        )}
                    </div>

                    {/* ë°±ì—…/ë³µì› */}
                    <div style={{
                        background: '#fff', borderRadius: 22, padding: '20px', marginBottom: 16,
                        boxShadow: '0 2px 12px rgba(0,0,0,0.03)'
                    }}>
                        <h3 style={{ fontSize: 16, fontWeight: 800, marginBottom: 14 }}>ğŸ’¾ ë°±ì—… / ë³µì›</h3>
                        <p style={{ fontSize: 13, color: 'var(--text-sub)', marginBottom: 14, lineHeight: 1.5 }}>
                            ê¸°ë¡ì„ íŒŒì¼ë¡œ ë‚´ë³´ë‚´ê±°ë‚˜, íŒŒì¼ì—ì„œ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ìˆì–´ìš”.
                        </p>
                        <div style={{ display: 'flex', gap: 8 }}>
                            <button onClick={handleExportBackup} style={{
                                flex: 1, padding: '14px', borderRadius: 14,
                                background: 'var(--bg-sub)', color: 'var(--primary)',
                                fontSize: 14, fontWeight: 700
                            }}>ğŸ“¤ ë‚´ë³´ë‚´ê¸°</button>
                            <button onClick={handleImportBackup} style={{
                                flex: 1, padding: '14px', borderRadius: 14,
                                background: 'var(--bg-sub)', color: 'var(--primary)',
                                fontSize: 14, fontWeight: 700
                            }}>ğŸ“¥ ë¶ˆëŸ¬ì˜¤ê¸°</button>
                        </div>
                    </div>

                    {/* ì•± ì •ë³´ */}
                    <div style={{
                        background: '#fff', borderRadius: 22, padding: '20px',
                        boxShadow: '0 2px 12px rgba(0,0,0,0.03)', textAlign: 'center'
                    }}>
                        <p style={{ fontSize: 14, color: 'var(--text-sub)' }}>Heart Log v1.0</p>
                        <p style={{ fontSize: 13, color: 'var(--text-sub)', marginTop: 4 }}>ì´ ê¸°ë¡: {records.length}ê±´</p>
                    </div>
                </div>
            );
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // App (ë£¨íŠ¸)
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        function App() {
            const [activeTab, setActiveTab] = useState('home');
            const [isRecording, setIsRecording] = useState(false);
            const [records, setRecords] = useState(() => loadRecords());
            const [toast, setToast] = useState({ show: false, message: '' });

            // íƒ€ì´ë¨¸ ìƒíƒœ
            const [timerRunning, setTimerRunning] = useState(false);
            const [timerStart, setTimerStart] = useState(null);
            const [timerElapsed, setTimerElapsed] = useState(0);
            const timerRef = useRef(null);

            // íƒ€ì´ë¨¸ ì¸í„°ë²Œ
            useEffect(() => {
                if (timerRunning && timerStart) {
                    timerRef.current = setInterval(() => {
                        setTimerElapsed(Date.now() - timerStart);
                    }, 200);
                    return () => clearInterval(timerRef.current);
                }
            }, [timerRunning, timerStart]);

            // recordsê°€ ë³€ê²½ë  ë•Œ ì €ì¥
            useEffect(() => { saveRecords(records); }, [records]);

            const todayCount = records.filter(r => isSameDay(r.timestamp, new Date())).length;

            const handleAlarm = () => setIsRecording(true);

            const handleSave = async (newRecord) => {
                setRecords(prev => [newRecord, ...prev]);
                setIsRecording(false);

                // íƒ€ì´ë¨¸ ë¦¬ì…‹
                if (timerRunning) {
                    setTimerRunning(false);
                    clearInterval(timerRef.current);
                }
                setTimerElapsed(0);
                setTimerStart(null);

                // í´ë¼ìš°ë“œ ë™ê¸°í™”
                const syncResult = await syncToSheet(newRecord);
                const syncMsg = syncResult.ok ? 'ì €ì¥í–ˆì–´ìš”! ğŸ’“ (â˜ï¸ ë™ê¸°í™” ì™„ë£Œ)' : 'ì €ì¥í–ˆì–´ìš”! ğŸ’“';

                setToast({ show: true, message: syncMsg });
                setTimeout(() => setToast({ show: false, message: '' }), 2500);
            };

            const handleDelete = (id) => {
                setRecords(prev => prev.filter(r => r.id !== id));
                syncDeleteToSheet(id);
                setToast({ show: true, message: 'ì‚­ì œí–ˆì–´ìš”' });
                setTimeout(() => setToast({ show: false, message: '' }), 2000);
            };

            const handleTimerStart = () => {
                setTimerStart(Date.now());
                setTimerRunning(true);
                setTimerElapsed(0);
            };

            const handleTimerStop = () => {
                setTimerRunning(false);
                clearInterval(timerRef.current);
                // timerElapsedëŠ” ìœ ì§€ (ê¸°ë¡í•  ë•Œ ì‚¬ìš©)
            };

            return (
                <div>
                    <Toast message={toast.message} show={toast.show} />

                    {activeTab === 'home' && (
                        <MainScreen
                            todayCount={todayCount}
                            onAlarm={handleAlarm}
                            timerRunning={timerRunning}
                            timerElapsed={timerElapsed}
                            onTimerStart={handleTimerStart}
                            onTimerStop={handleTimerStop}
                        />
                    )}
                    {activeTab === 'history' && (
                        <RecordScreen records={records} onDeleteRecord={handleDelete} />
                    )}
                    {activeTab === 'stats' && (
                        <StatsScreen records={records} />
                    )}
                    {activeTab === 'settings' && (
                        <SettingsScreen records={records} />
                    )}

                    <SymptomRecordPanel
                        isOpen={isRecording}
                        onClose={() => setIsRecording(false)}
                        onSave={handleSave}
                        timerElapsed={timerElapsed > 0 ? timerElapsed : null}
                    />

                    <TabBar activeTab={activeTab} onTabChange={setActiveTab} />
                </div>
            );
        }

        ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
</body>
</html>
